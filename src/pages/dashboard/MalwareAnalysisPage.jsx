import { useState, useRef, useEffect } from 'react'
import { motion } from 'framer-motion'
import { Upload, FileCode, ShieldAlert, Bug, Terminal, Activity, Binary, Code, ChevronDown, ChevronUp, Download, Sparkles, GitBranch, Loader2 } from 'lucide-react'
import { Button } from '../../components/ui/Button'
import { mockDecompilerResponse, mockAnalysisResponse } from '../../data/mockMalwareData'
import mermaid from 'mermaid'
import jsPDF from 'jspdf'
import ReactMarkdown from 'react-markdown'
import 'jspdf-autotable'

// Initialize mermaid
mermaid.initialize({
    startOnLoad: false,
    theme: 'dark',
    securityLevel: 'loose',
    themeVariables: {
        primaryColor: '#39FF14',
        primaryTextColor: '#fff',
        primaryBorderColor: '#39FF14',
        lineColor: '#666',
        secondaryColor: '#1a1a2e',
        tertiaryColor: '#0a0e17',
        background: '#0a0e17',
        mainBkg: '#1a1a2e',
        nodeBorder: '#39FF14',
        clusterBkg: '#1a1a2e',
        clusterBorder: '#333',
        titleColor: '#39FF14',
        edgeLabelBackground: '#1a1a2e',
    }
})

// LocalStorage helpers
const STORAGE_KEYS = {
    DIAGRAM: 'intelx_malware_diagram',
    SUMMARY: 'intelx_malware_summary'
}

const saveToStorage = (key, fileHash, data) => {
    try {
        localStorage.setItem(key, JSON.stringify({ fileHash, data, timestamp: Date.now() }))
    } catch (e) {
        console.warn('LocalStorage save failed:', e)
    }
}

const getFromStorage = (key, fileHash) => {
    try {
        const stored = localStorage.getItem(key)
        if (!stored) return null
        const parsed = JSON.parse(stored)
        // Check if it's for the same file (using hash)
        if (parsed.fileHash === fileHash) {
            return parsed.data
        }
        return null
    } catch (e) {
        return null
    }
}

const getFileHash = async (file) => {
    // Simple hash based on name + size + last modified
    return `${file.name}_${file.size}_${file.lastModified}`
}

const TerminalLine = ({ text, delay = 0, color = 'text-foreground/70' }) => (
    <motion.div
        initial={{ opacity: 0, x: -10 }}
        animate={{ opacity: 1, x: 0 }}
        transition={{ delay, duration: 0.3 }}
        className={`font-mono text-xs ${color}`}
    >
        <span className="text-foreground/30 mr-2">$</span>
        {text}
    </motion.div>
)

export default function MalwareAnalysisPage() {
    const [file, setFile] = useState(null)
    const [fileHash, setFileHash] = useState(null)
    const [analyzing, setAnalyzing] = useState(false)
    const [decompiledData, setDecompiledData] = useState(null)
    const [analysisReport, setAnalysisReport] = useState(null)
    const [logs, setLogs] = useState([])
    const [error, setError] = useState(null)
    const [activeTab, setActiveTab] = useState('decompiled')
    const [isExpanded, setIsExpanded] = useState(false)
    const fileInputRef = useRef(null)

    // AI features states
    const [aiSummary, setAiSummary] = useState(null)
    const [aiSummaryLoading, setAiSummaryLoading] = useState(false)
    const [diagram, setDiagram] = useState(null)
    const [diagramLoading, setDiagramLoading] = useState(false)
    const [pdfGenerating, setPdfGenerating] = useState(false)

    const diagramRef = useRef(null)

    const allowedExtensions = ['exe', 'dll', 'so', 'elf', 'bin', 'o', 'out']

    const validateFile = (fileName) => {
        const extension = fileName.split('.').pop().toLowerCase()
        if (!allowedExtensions.includes(extension)) {
            setError(`Invalid file type. Allowed: ${allowedExtensions.join(', ').toUpperCase()}`)
            return false
        }
        setError(null)
        return true
    }

    const handleFileSelect = async (e) => {
        if (e.target.files && e.target.files[0]) {
            const selectedFile = e.target.files[0]
            if (validateFile(selectedFile.name)) {
                const hash = await getFileHash(selectedFile)
                setFileHash(hash)
                setFile({
                    name: selectedFile.name,
                    size: (selectedFile.size / (1024 * 1024)).toFixed(2) + ' MB',
                    rawFile: selectedFile,
                    isExample: false
                })
                // Check localStorage for cached data
                const cachedDiagram = getFromStorage(STORAGE_KEYS.DIAGRAM, hash)
                const cachedSummary = getFromStorage(STORAGE_KEYS.SUMMARY, hash)
                if (cachedDiagram) setDiagram(cachedDiagram)
                if (cachedSummary) setAiSummary(cachedSummary)
            }
        }
    }

    const handleFileDrop = async (e) => {
        e.preventDefault()
        const droppedFile = e.dataTransfer.files[0]
        if (droppedFile) {
            if (validateFile(droppedFile.name)) {
                const hash = await getFileHash(droppedFile)
                setFileHash(hash)
                setFile({
                    name: droppedFile.name,
                    size: (droppedFile.size / (1024 * 1024)).toFixed(2) + ' MB',
                    rawFile: droppedFile,
                    isExample: false
                })
                const cachedDiagram = getFromStorage(STORAGE_KEYS.DIAGRAM, hash)
                const cachedSummary = getFromStorage(STORAGE_KEYS.SUMMARY, hash)
                if (cachedDiagram) setDiagram(cachedDiagram)
                if (cachedSummary) setAiSummary(cachedSummary)
            }
        }
    }

    const addLog = (text, color = 'text-foreground/70') => {
        setLogs(prev => [...prev, { text, color }])
    }

    // Generate AI Summary
    const generateAiSummary = async () => {
        if (!file?.rawFile) return

        // Check cache first
        if (fileHash) {
            const cached = getFromStorage(STORAGE_KEYS.SUMMARY, fileHash)
            if (cached) {
                setAiSummary(cached)
                return
            }
        }

        setAiSummaryLoading(true)

        try {
            const formData = new FormData()
            formData.append('file', file.rawFile)

            const res = await fetch('http://localhost:5000/api/malware-analyzer/ai-summary', {
                method: 'POST',
                body: formData
            })

            if (!res.ok) throw new Error(`API error: ${res.statusText}`)
            const data = await res.json()

            if (data.success) {
                setAiSummary(data.ai_response)
                // Save to localStorage
                if (fileHash) {
                    saveToStorage(STORAGE_KEYS.SUMMARY, fileHash, data.ai_response)
                }
            } else {
                throw new Error(data.error || 'Failed to generate summary')
            }
        } catch (err) {
            setError(err.message)
        } finally {
            setAiSummaryLoading(false)
        }
    }

    // Generate Diagram
    const generateDiagram = async () => {
        if (!file?.rawFile) return

        // Check cache first
        if (fileHash) {
            const cached = getFromStorage(STORAGE_KEYS.DIAGRAM, fileHash)
            console.log('Cached diagram:', cached)
            console.log('Current fileHash:', fileHash)
            if (cached) {
                console.log('Setting diagram from cache')
                setDiagram(cached)
                return
            }
        }

        setDiagramLoading(true)

        try {
            const formData = new FormData()
            formData.append('file', file.rawFile)

            const res = await fetch('http://localhost:5000/api/malware-analyzer/diagram-generator', {
                method: 'POST',
                body: formData
            })

            if (!res.ok) throw new Error(`API error: ${res.statusText}`)
            const data = await res.json()

            if (data.success) {
                setDiagram(data.ai_response)
                // Save to localStorage
                if (fileHash) {
                    saveToStorage(STORAGE_KEYS.DIAGRAM, fileHash, data.ai_response)
                }
            } else {
                throw new Error(data.error || 'Failed to generate diagram')
            }
        } catch (err) {
            setError(err.message)
        } finally {
            setDiagramLoading(false)
        }
    }

    // Render mermaid diagram when it changes
    useEffect(() => {
        console.log('useEffect triggered with diagram:', diagram ? 'present' : 'null')
        console.log('diagramRef.current:', diagramRef.current)
        if (diagram && diagramRef.current) {
            const renderDiagram = async () => {
                try {
                    console.log('Starting mermaid render...')
                    diagramRef.current.innerHTML = ''
                    const id = `mermaid-${Date.now()}`
                    const { svg } = await mermaid.render(id, diagram)
                    console.log('Mermaid render successful, SVG length:', svg.length)
                    diagramRef.current.innerHTML = svg
                } catch (err) {
                    console.error('Mermaid render error:', err)
                    diagramRef.current.innerHTML = `<pre class="text-red-500 text-sm p-4">${err.message}</pre>`
                }
            }
            renderDiagram()
        }
    }, [diagram])

    // Generate PDF Report
    const generatePdfReport = async () => {
        if (!analysisReport || !decompiledData) return
        setPdfGenerating(true)

        try {
            const pdf = new jsPDF('p', 'mm', 'a4')
            const pageWidth = pdf.internal.pageSize.getWidth()
            const pageHeight = pdf.internal.pageSize.getHeight()

            const neonGreen = [57, 255, 20]
            const darkBg = [10, 14, 23]
            const white = [255, 255, 255]
            const red = [239, 68, 68]
            const yellow = [250, 204, 21]
            const green = [34, 197, 94]

            pdf.setFillColor(...darkBg)
            pdf.rect(0, 0, pageWidth, 45, 'F')

            pdf.setDrawColor(...neonGreen)
            pdf.setLineWidth(1)
            pdf.line(0, 45, pageWidth, 45)

            pdf.setTextColor(...neonGreen)
            pdf.setFontSize(24)
            pdf.setFont('helvetica', 'bold')
            pdf.text('IntelX', 15, 20)

            pdf.setTextColor(...white)
            pdf.setFontSize(10)
            pdf.setFont('helvetica', 'normal')
            pdf.text('MALWARE ANALYSIS REPORT', 15, 28)

            pdf.setFontSize(8)
            pdf.setTextColor(180, 180, 180)
            pdf.text(`Generated: ${new Date().toLocaleString()}`, 15, 38)
            pdf.text(`File: ${file?.name || 'Unknown'}`, pageWidth - 60, 38)

            const stats = analysisReport.report.data.attributes.stats
            const threatLevel = stats.malicious > 5 ? 'HIGH' : stats.malicious > 0 ? 'MEDIUM' : 'LOW'
            const threatColor = threatLevel === 'HIGH' ? red : threatLevel === 'MEDIUM' ? yellow : green

            pdf.setFillColor(...threatColor)
            pdf.roundedRect(pageWidth - 55, 12, 40, 12, 2, 2, 'F')
            pdf.setTextColor(0, 0, 0)
            pdf.setFontSize(8)
            pdf.setFont('helvetica', 'bold')
            pdf.text(`THREAT: ${threatLevel}`, pageWidth - 52, 20)

            let yPos = 55

            pdf.setTextColor(...neonGreen)
            pdf.setFontSize(12)
            pdf.setFont('helvetica', 'bold')
            pdf.text('FILE INFORMATION', 15, yPos)
            yPos += 8

            const fileInfo = analysisReport.report.meta.file_info
            const fileData = [
                ['Filename', file?.name || 'N/A'],
                ['SHA256', fileInfo.sha256],
                ['MD5', fileInfo.md5],
                ['File Size', `${fileInfo.size} bytes`],
                ['File Type', 'ELF 64-bit executable'],
            ]

            pdf.autoTable({
                startY: yPos,
                head: [],
                body: fileData,
                theme: 'plain',
                styles: { textColor: [255, 255, 255], fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    0: { fontStyle: 'bold', textColor: [150, 150, 150], cellWidth: 35 },
                    1: { fontStyle: 'normal', textColor: [255, 255, 255] },
                },
                margin: { left: 15 },
            })

            yPos = pdf.lastAutoTable.finalY + 10

            pdf.setTextColor(...neonGreen)
            pdf.setFontSize(12)
            pdf.setFont('helvetica', 'bold')
            pdf.text('THREAT INTELLIGENCE', 15, yPos)
            yPos += 8

            const boxWidth = 50, boxHeight = 25, boxSpacing = 5, startX = 15

            pdf.setFillColor(239, 68, 68, 0.2)
            pdf.setDrawColor(239, 68, 68)
            pdf.roundedRect(startX, yPos, boxWidth, boxHeight, 2, 2, 'FD')
            pdf.setTextColor(...red)
            pdf.setFontSize(16)
            pdf.setFont('helvetica', 'bold')
            pdf.text(String(stats.malicious), startX + boxWidth / 2, yPos + 12, { align: 'center' })
            pdf.setFontSize(7)
            pdf.text('MALICIOUS', startX + boxWidth / 2, yPos + 20, { align: 'center' })

            pdf.setFillColor(250, 204, 21, 0.2)
            pdf.setDrawColor(250, 204, 21)
            pdf.roundedRect(startX + boxWidth + boxSpacing, yPos, boxWidth, boxHeight, 2, 2, 'FD')
            pdf.setTextColor(...yellow)
            pdf.setFontSize(16)
            pdf.setFont('helvetica', 'bold')
            pdf.text(String(stats.suspicious), startX + boxWidth + boxSpacing + boxWidth / 2, yPos + 12, { align: 'center' })
            pdf.setFontSize(7)
            pdf.text('SUSPICIOUS', startX + boxWidth + boxSpacing + boxWidth / 2, yPos + 20, { align: 'center' })

            pdf.setFillColor(34, 197, 94, 0.2)
            pdf.setDrawColor(34, 197, 94)
            pdf.roundedRect(startX + 2 * (boxWidth + boxSpacing), yPos, boxWidth, boxHeight, 2, 2, 'FD')
            pdf.setTextColor(...green)
            pdf.setFontSize(16)
            pdf.setFont('helvetica', 'bold')
            pdf.text(String(stats.harmless), startX + 2 * (boxWidth + boxSpacing) + boxWidth / 2, yPos + 12, { align: 'center' })
            pdf.setFontSize(7)
            pdf.text('HARMLESS', startX + 2 * (boxWidth + boxSpacing) + boxWidth / 2, yPos + 20, { align: 'center' })

            yPos += boxHeight + 15

            pdf.setTextColor(...neonGreen)
            pdf.setFontSize(12)
            pdf.setFont('helvetica', 'bold')
            pdf.text('DECOMPILED CODE (PREVIEW)', 15, yPos)
            yPos += 5

            pdf.setFillColor(30, 30, 30)
            pdf.setDrawColor(60, 60, 60)
            const codeBoxHeight = 60
            pdf.roundedRect(15, yPos, pageWidth - 30, codeBoxHeight, 2, 2, 'FD')

            pdf.setTextColor(200, 200, 200)
            pdf.setFontSize(6)
            pdf.setFont('courier', 'normal')

            const codeLines = decompiledData.decompiled.split('\n').slice(0, 20)
            let codeY = yPos + 5
            codeLines.forEach((line) => {
                if (codeY < yPos + codeBoxHeight - 5) {
                    pdf.text(line.substring(0, 100), 18, codeY)
                    codeY += 3
                }
            })

            yPos += codeBoxHeight + 10

            if (aiSummary) {
                if (yPos > pageHeight - 60) { pdf.addPage(); yPos = 20 }
                pdf.setTextColor(...neonGreen)
                pdf.setFontSize(12)
                pdf.setFont('helvetica', 'bold')
                pdf.text('AI ANALYSIS SUMMARY', 15, yPos)
                yPos += 8
                pdf.setTextColor(...white)
                pdf.setFontSize(8)
                pdf.setFont('helvetica', 'normal')
                const summaryLines = pdf.splitTextToSize(aiSummary, pageWidth - 30)
                pdf.text(summaryLines.slice(0, 15), 15, yPos)
            }

            const addFooter = (pageNum) => {
                pdf.setFillColor(...darkBg)
                pdf.rect(0, pageHeight - 15, pageWidth, 15, 'F')
                pdf.setDrawColor(...neonGreen)
                pdf.line(0, pageHeight - 15, pageWidth, pageHeight - 15)
                pdf.setTextColor(...neonGreen)
                pdf.setFontSize(8)
                pdf.text('IntelX Security Platform', 15, pageHeight - 6)
                pdf.setTextColor(150, 150, 150)
                pdf.text(`Page ${pageNum}`, pageWidth - 25, pageHeight - 6)
                pdf.text('CONFIDENTIAL', pageWidth / 2, pageHeight - 6, { align: 'center' })
            }

            const totalPages = pdf.internal.getNumberOfPages()
            for (let i = 1; i <= totalPages; i++) { pdf.setPage(i); addFooter(i) }

            pdf.save(`IntelX_MalwareReport_${file?.name || 'analysis'}_${Date.now()}.pdf`)
        } catch (err) {
            console.error('PDF generation error:', err)
            setError('Failed to generate PDF report')
        } finally {
            setPdfGenerating(false)
        }
    }

    const handleScan = async () => {
        if (!file) return
        setAnalyzing(true)
        setLogs([])
        setDecompiledData(null)
        setAnalysisReport(null)
        setError(null)

        if (file.isExample) {
            const logSequence = [
                { text: `[+] Initializing static analysis engine...`, delay: 0.2 },
                { text: `[+] Uploading ${file.name} to sandbox...`, delay: 0.8 },
                { text: `[*] Parsing ELF header structure...`, delay: 1.5 },
                { text: `[*] Disassembling .text section...`, delay: 2.2 },
                { text: `[*] Reconstructing control flow graph...`, delay: 3.0 },
                { text: `[*] Extracting symbol table...`, delay: 3.8 },
                { text: `[*] Analyzing entropy and sections...`, delay: 4.5 },
                { text: `[+] Querying threat intelligence database...`, delay: 5.2 },
                { text: `[!] Suspicious system calls detected...`, delay: 6.0, color: 'text-neon-yellow' },
                { text: `[+] Generating decompilation report...`, delay: 6.8 }
            ]
            logSequence.forEach((log) => {
                setTimeout(() => addLog(log.text, log.color), log.delay * 1000)
            })
            setTimeout(() => {
                setDecompiledData(mockDecompilerResponse)
                setAnalysisReport(mockAnalysisResponse)
                setAnalyzing(false)
            }, 7500)
            return
        }

        addLog(`[+] Initializing static analysis engine...`)
        addLog(`[+] Uploading ${file.name} to backend...`)

        const decompileFormData = new FormData()
        decompileFormData.append('file', file.rawFile)

        const analyzerFormData = new FormData()
        analyzerFormData.append('file', file.rawFile)

        try {
            addLog(`[*] Calling decompilation & threat analysis services (parallel)...`)

            const [decompileRes, analyzerRes] = await Promise.all([
                fetch('http://localhost:5000/api/malware-analyzer/decompile', {
                    method: 'POST',
                    body: decompileFormData
                }),
                fetch('http://localhost:5000/api/malware-analyzer/file-analysis', {
                    method: 'POST',
                    body: analyzerFormData
                })
            ])

            if (!decompileRes.ok) throw new Error(`Decompile API error: ${decompileRes.statusText}`)
            if (!analyzerRes.ok) throw new Error(`Analyzer API error: ${analyzerRes.statusText}`)

            const [decompileJson, analyzerJson] = await Promise.all([
                decompileRes.json(),
                analyzerRes.json()
            ])

            addLog(`[+] Decompilation complete.`, 'text-neon-green')
            addLog(`[+] Threat analysis complete.`, 'text-neon-green')

            setDecompiledData(decompileJson)
            setAnalysisReport(analyzerJson)

        } catch (err) {
            addLog(`[!] Error: ${err.message}`, 'text-red-500')
            setError(err.message)
        } finally {
            setAnalyzing(false)
        }
    }

    const clearFile = () => {
        setFile(null)
        setFileHash(null)
        setDecompiledData(null)
        setAnalysisReport(null)
        setAiSummary(null)
        setDiagram(null)
        setError(null)
        setLogs([])
    }

    return (
        <div className="max-w-7xl mx-auto space-y-8 pb-20">

            {/* Header */}
            <div className="flex items-center justify-between">
                <div>
                    <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                        <Bug className="text-neon-green" /> Malware Sandbox
                    </h2>
                    <p className="text-foreground/60">Static & Dynamic Analysis Environment</p>
                </div>
                <div className="flex gap-2 items-center">
                    {analysisReport && (
                        <Button
                            variant="outline"
                            className="text-xs h-9 px-4 flex items-center gap-2"
                            onClick={generatePdfReport}
                            disabled={pdfGenerating}
                        >
                            {pdfGenerating ? <Loader2 size={14} className="animate-spin" /> : <Download size={14} />}
                            {pdfGenerating ? 'Generating...' : 'Download Report'}
                        </Button>
                    )}
                    <div className="px-3 py-1 rounded bg-red-500/10 border border-red-500/20 text-red-500 text-xs font-mono flex items-center gap-2">
                        <ShieldAlert size={14} /> LIVE DECOMPILATION PREPARED
                    </div>
                </div>
            </div>

            {/* Dynamic Layout Container */}
            <div className={analyzing || decompiledData ? "grid grid-cols-1 lg:grid-cols-12 gap-6" : "max-w-xl mx-auto mt-20"}>

                {/* Left Column: Upload & Control */}
                <div className={analyzing || decompiledData ? "lg:col-span-4 space-y-6" : "space-y-6"}>

                    <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileSelect} />

                    {/* Upload Zone */}
                    <motion.div
                        layout
                        className={`border-2 border-dashed rounded-xl p-8 flex flex-col items-center justify-center text-center transition-all cursor-pointer relative overflow-hidden
                            ${file ? 'border-neon-green/50 bg-neon-green/5' : 'border-white/10 hover:border-white/20 hover:bg-white/[0.02]'}
                            ${analyzing ? 'pointer-events-none opacity-50' : ''}`}
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={handleFileDrop}
                        onClick={() => !file && fileInputRef.current?.click()}
                    >
                        {file ? (
                            <>
                                <FileCode className="w-12 h-12 text-neon-green mb-4" />
                                <div className="font-mono text-white mb-1">{file.name}</div>
                                <div className="text-xs text-foreground/40">{file.size}</div>
                                <Button variant="outline" className="mt-4 text-xs h-8" onClick={(e) => { e.stopPropagation(); clearFile(); }}>
                                    Remove
                                </Button>
                            </>
                        ) : (
                            <>
                                <Upload className="w-12 h-12 text-foreground/20 mb-4" />
                                <div className="text-foreground/60 mb-2">Drop file to analyze</div>
                                <div className="text-xs text-foreground/30 font-mono mb-4">OR CLICK TO UPLOAD</div>
                                <div className="mt-6 text-[10px] text-foreground/40 font-mono border border-foreground/10 px-2 py-1 rounded">
                                    SUPPORTED: {allowedExtensions.map(e => e.toUpperCase()).join(', ')}
                                </div>
                                {error && (
                                    <motion.div initial={{ opacity: 0, y: 5 }} animate={{ opacity: 1, y: 0 }} className="mt-4 text-xs text-red-500 bg-red-500/10 px-3 py-2 rounded border border-red-500/20 flex items-center gap-2">
                                        <ShieldAlert size={12} /> {error}
                                    </motion.div>
                                )}
                            </>
                        )}
                    </motion.div>

                    <Button variant="primary" className="w-full h-12 text-lg" disabled={!file || analyzing} onClick={handleScan}>
                        {analyzing ? <span className="flex items-center gap-2"><Activity className="animate-spin" /> Analyzing...</span> : 'Submit File'}
                    </Button>

                    {/* Terminal Log */}
                    {(analyzing || decompiledData) && (
                        <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="rounded-xl border border-white/10 bg-black p-4 font-mono h-[300px] overflow-y-auto custom-scrollbar relative">
                            <div className="absolute top-2 right-4 text-xs text-foreground/20 flex items-center gap-1"><Terminal size={12} /> STATIC ANALYSIS LOG</div>
                            <div className="space-y-1 mt-4">
                                {logs.map((log, i) => <TerminalLine key={i} text={log.text} color={log.color} />)}
                                {analyzing && <motion.div animate={{ opacity: [0, 1, 0] }} transition={{ duration: 0.8, repeat: Infinity }} className="w-2 h-4 bg-neon-green mt-1 inline-block" />}
                            </div>
                        </motion.div>
                    )}

                    {/* Threat Intelligence - Only this stays in left column */}
                    {analysisReport && (
                        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                            <div className="p-4 rounded-xl border border-white/10 bg-white/[0.03]">
                                <h4 className="text-sm font-bold text-white mb-3 flex items-center gap-2"><ShieldAlert size={14} className="text-red-500" /> Threat Intelligence</h4>
                                <div className="flex justify-between items-center mb-4">
                                    <div className="text-center"><div className="text-2xl font-bold text-red-500">{analysisReport.report.data.attributes.stats.malicious}</div><div className="text-[10px] text-foreground/40 uppercase">Malicious</div></div>
                                    <div className="text-center"><div className="text-2xl font-bold text-neon-yellow">{analysisReport.report.data.attributes.stats.suspicious}</div><div className="text-[10px] text-foreground/40 uppercase">Suspicious</div></div>
                                    <div className="text-center"><div className="text-2xl font-bold text-green-500">{analysisReport.report.data.attributes.stats.harmless}</div><div className="text-[10px] text-foreground/40 uppercase">Harmless</div></div>
                                </div>
                                <div className="text-xs font-mono text-foreground/60 space-y-1 border-t border-white/5 pt-3">
                                    <div className="flex justify-between"><span>SHA256:</span> <span className="text-white">{analysisReport.report.meta.file_info.sha256.substring(0, 12)}...</span></div>
                                    <div className="flex justify-between"><span>Size:</span> <span className="text-white">{analysisReport.report.meta.file_info.size} bytes</span></div>
                                    <div className="flex justify-between"><span>Format:</span> <span className="text-white">ELF 64-bit</span></div>
                                </div>
                            </div>
                        </motion.div>
                    )}
                </div>

                {/* Right Column: Results Stack */}
                {(analyzing || decompiledData) && (
                    <div className="lg:col-span-8 space-y-6">

                        {/* Decompiled Code Section */}
                        {!decompiledData ? (
                            <div className="rounded-xl border border-white/5 bg-white/[0.02] flex flex-col items-center justify-center text-foreground/20 animate-pulse min-h-[600px]">
                                <Code className="w-24 h-24 mb-4 opacity-20" />
                                <p>Decompiling binary...</p>
                                <p className="text-xs mt-2">Running objdump & Ghidra analysis</p>
                            </div>
                        ) : (
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex flex-col bg-[#1e1e1e] rounded-xl border border-white/10 overflow-hidden shadow-2xl">
                                <div className="flex items-center justify-between px-4 py-2 bg-[#2d2d2d] border-b border-black">
                                    <div className="flex items-center gap-1">
                                        <button onClick={() => setActiveTab('decompiled')} className={`px-3 py-1.5 text-xs font-mono flex items-center gap-2 rounded-t transition-colors ${activeTab === 'decompiled' ? 'bg-[#1e1e1e] text-neon-green' : 'text-foreground/40 hover:text-foreground'}`}><Code size={12} /> pseudo_code.c</button>
                                        <button onClick={() => setActiveTab('objdump')} className={`px-3 py-1.5 text-xs font-mono flex items-center gap-2 rounded-t transition-colors ${activeTab === 'objdump' ? 'bg-[#1e1e1e] text-neon-yellow' : 'text-foreground/40 hover:text-foreground'}`}><Binary size={12} /> disassembly.asm</button>
                                    </div>
                                    <div className="text-[10px] text-foreground/30 font-mono">READ-ONLY</div>
                                </div>
                                <div className={`relative p-4 font-mono text-sm bg-[#1e1e1e] ${isExpanded ? '' : 'max-h-[600px] overflow-hidden'}`}>
                                    <pre className="text-gray-300 leading-relaxed overflow-x-auto"><code>{activeTab === 'decompiled' ? decompiledData.decompiled : decompiledData.objdump}</code></pre>
                                    {!isExpanded && <div className="absolute inset-x-0 bottom-0 h-40 bg-gradient-to-t from-[#1e1e1e] via-[#1e1e1e]/80 to-transparent pointer-events-none" />}
                                </div>
                                <div className="bg-[#1e1e1e] border-t border-white/5 p-2 flex justify-center">
                                    <button onClick={() => setIsExpanded(!isExpanded)} className="flex items-center gap-2 px-4 py-2 text-xs font-mono text-neon-green hover:bg-neon-green/10 rounded transition-colors">
                                        {isExpanded ? <><ChevronUp size={14} /> Show Less</> : <><ChevronDown size={14} /> Show Full Source</>}
                                    </button>
                                </div>
                            </motion.div>
                        )}
                    </div>
                )}
            </div>

            {/* SEPARATE BOX 1: Flow Diagram - Below the main grid */}
            {decompiledData && (
                <motion.div
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    className="bg-[#1e1e1e] rounded-xl border border-white/10 overflow-hidden shadow-2xl"
                >
                    {/* Header with title and generate button */}
                    <div className="flex items-center justify-between px-6 py-4 bg-[#2d2d2d] border-b border-black">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-lg bg-cyan-500/20 flex items-center justify-center">
                                <GitBranch size={20} className="text-cyan-400" />
                            </div>
                            <div>
                                <h3 className="text-lg font-bold text-white">Execution Flow Diagram</h3>
                                <p className="text-xs text-foreground/40">Visualize the malware's execution flow</p>
                            </div>
                        </div>
                        <Button
                            variant="outline"
                            className="text-xs h-9 px-4 flex items-center gap-2"
                            onClick={generateDiagram}
                            disabled={diagramLoading || !file?.rawFile}
                        >
                            {diagramLoading ? <Loader2 size={14} className="animate-spin" /> : <GitBranch size={14} />}
                            {diagram ? 'Regenerate Diagram' : 'Generate Diagram'}
                        </Button>
                    </div>

                    {/* Content - expands to fit */}
                    {diagram ? (
                        <div className="p-6 bg-[#1a1a2e] overflow-x-auto">
                            <div ref={diagramRef} className="mermaid-container w-full flex items-center justify-center" />
                        </div>
                    ) : (
                        <div className="p-12 flex flex-col items-center justify-center text-foreground/30">
                            <GitBranch size={48} className="mb-4 opacity-30" />
                            <p className="text-sm">Click "Generate Diagram" to visualize execution flow</p>
                            <p className="text-xs mt-1 text-foreground/20">Powered by Mermaid.js</p>
                        </div>
                    )}
                </motion.div>
            )}

            {/* SEPARATE BOX 2: AI Summary - Below flow diagram */}
            {decompiledData && (
                <motion.div
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.1 }}
                    className="bg-[#1e1e1e] rounded-xl border border-white/10 overflow-hidden shadow-2xl"
                >
                    {/* Header with title and generate button */}
                    <div className="flex items-center justify-between px-6 py-4 bg-[#2d2d2d] border-b border-black">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                                <Sparkles size={20} className="text-purple-400" />
                            </div>
                            <div>
                                <h3 className="text-lg font-bold text-white">AI Threat Summary</h3>
                                <p className="text-xs text-foreground/40">AI-powered analysis of the malware behavior</p>
                            </div>
                        </div>
                        <Button
                            variant="outline"
                            className="text-xs h-9 px-4 flex items-center gap-2"
                            onClick={generateAiSummary}
                            disabled={aiSummaryLoading || !file?.rawFile}
                        >
                            {aiSummaryLoading ? <Loader2 size={14} className="animate-spin" /> : <Sparkles size={14} />}
                            {aiSummary ? 'Regenerate Summary' : 'Generate Summary'}
                        </Button>
                    </div>

                    {/* Content - code editor style, expands to fit */}
                    {aiSummary ? (
                        <div className="p-6">
                            <div className="bg-black/50 rounded-lg border border-white/5 p-6 font-mono text-sm leading-relaxed text-gray-300">
                                <ReactMarkdown
                                    components={{
                                        // Style basic markdown elements to match the dark theme and code look
                                        h1: ({ node, ...props }) => <h1 className="text-xl font-bold text-neon-green mb-4 border-b border-white/10 pb-2" {...props} />,
                                        h2: ({ node, ...props }) => <h2 className="text-lg font-bold text-white mb-3 mt-6" {...props} />,
                                        h3: ({ node, ...props }) => <h3 className="text-md font-bold text-white mb-2 mt-4" {...props} />,
                                        p: ({ node, ...props }) => <p className="mb-4 last:mb-0" {...props} />,
                                        ul: ({ node, ...props }) => <ul className="list-disc pl-5 mb-4 space-y-1" {...props} />,
                                        ol: ({ node, ...props }) => <ol className="list-decimal pl-5 mb-4 space-y-1" {...props} />,
                                        li: ({ node, ...props }) => <li className="text-gray-300" {...props} />,
                                        code: ({ node, inline, className, children, ...props }) => (
                                            inline
                                                ? <code className="bg-white/10 text-neon-yellow px-1 py-0.5 rounded text-xs font-mono" {...props}>{children}</code>
                                                : <pre className="bg-black/40 border border-white/10 p-3 rounded-lg overflow-x-auto my-4 text-xs font-mono text-gray-300" {...props}><code className="bg-transparent" {...props}>{children}</code></pre>
                                        ),
                                        blockquote: ({ node, ...props }) => <blockquote className="border-l-2 border-neon-green/50 pl-4 py-1 my-4 bg-neon-green/5 italic text-gray-400" {...props} />,
                                        strong: ({ node, ...props }) => <strong className="text-white font-bold" {...props} />
                                    }}
                                >
                                    {aiSummary}
                                </ReactMarkdown>
                            </div>
                        </div>
                    ) : (
                        <div className="p-12 flex flex-col items-center justify-center text-foreground/30">
                            <Sparkles size={48} className="mb-4 opacity-30" />
                            <p className="text-sm">Click "Generate Summary" to get AI-powered analysis</p>
                            <p className="text-xs mt-1 text-foreground/20">Analysis includes threat indicators, behavior patterns, and recommendations</p>
                        </div>
                    )}
                </motion.div>
            )}
        </div>
    )
}
