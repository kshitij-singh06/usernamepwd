import { useState, useRef } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { Upload, FileCode, CheckCircle, ShieldAlert, Bug, Terminal, Activity, FileSearch, Globe, FileText, Binary, Code, ChevronDown, ChevronUp } from 'lucide-react'
import { Button } from '../../components/ui/Button'
import { mockDecompilerResponse, mockAnalysisResponse } from '../../data/mockMalwareData'

const TerminalLine = ({ text, delay = 0, color = 'text-foreground/70' }) => (
    <motion.div
        initial={{ opacity: 0, x: -10 }}
        animate={{ opacity: 1, x: 0 }}
        transition={{ delay, duration: 0.3 }}
        className={`font-mono text-xs ${color}`}
    >
        <span className="text-foreground/30 mr-2">$</span>
        {text}
    </motion.div>
)

export default function MalwareAnalysisPage() {
    const [file, setFile] = useState(null) // { name, size, rawFile?, isExample }
    const [analyzing, setAnalyzing] = useState(false)
    const [decompiledData, setDecompiledData] = useState(null)
    const [analysisReport, setAnalysisReport] = useState(null)
    const [logs, setLogs] = useState([])
    const [error, setError] = useState(null)
    const [activeTab, setActiveTab] = useState('decompiled')
    const [isExpanded, setIsExpanded] = useState(false)
    const fileInputRef = useRef(null)

    const allowedExtensions = ['exe', 'dll', 'so', 'elf', 'bin', 'o', 'out']

    const validateFile = (fileName) => {
        const extension = fileName.split('.').pop().toLowerCase()
        if (!allowedExtensions.includes(extension)) {
            setError(`Invalid file type. Allowed: ${allowedExtensions.join(', ').toUpperCase()}`)
            return false
        }
        setError(null)
        return true
    }

    const handleFileSelect = (e) => {
        if (e.target.files && e.target.files[0]) {
            const selectedFile = e.target.files[0]
            if (validateFile(selectedFile.name)) {
                setFile({
                    name: selectedFile.name,
                    size: (selectedFile.size / (1024 * 1024)).toFixed(2) + ' MB',
                    rawFile: selectedFile,
                    isExample: false
                })
            }
        }
    }

    const handleFileDrop = (e) => {
        e.preventDefault()
        const droppedFile = e.dataTransfer.files[0]
        if (droppedFile) {
            if (validateFile(droppedFile.name)) {
                setFile({
                    name: droppedFile.name,
                    size: (droppedFile.size / (1024 * 1024)).toFixed(2) + ' MB',
                    rawFile: droppedFile,
                    isExample: false
                })
            }
        }
    }

    const loadExample = (e) => {
        e.stopPropagation()
        setError(null)
        setFile({ name: 'malware.out', size: '12.6 KB', isExample: true })
    }

    const addLog = (text, color = 'text-foreground/70') => {
        setLogs(prev => [...prev, { text, color }])
    }

    const handleScan = async () => {
        if (!file) return
        setAnalyzing(true)
        setLogs([])
        setDecompiledData(null)
        setAnalysisReport(null)
        setError(null)

        // If it's the example file, use mock data
        if (file.isExample) {
            const logSequence = [
                { text: `[+] Initializing static analysis engine...`, delay: 0.2 },
                { text: `[+] Uploading ${file.name} to sandbox...`, delay: 0.8 },
                { text: `[*] Parsing ELF header structure...`, delay: 1.5 },
                { text: `[*] Disassembling .text section...`, delay: 2.2 },
                { text: `[*] Reconstructing control flow graph...`, delay: 3.0 },
                { text: `[*] Extracting symbol table...`, delay: 3.8 },
                { text: `[*] Analyzing entropy and sections...`, delay: 4.5 },
                { text: `[+] Querying threat intelligence database...`, delay: 5.2 },
                { text: `[!] Suspicious system calls detected...`, delay: 6.0, color: 'text-neon-yellow' },
                { text: `[+] Generating decompilation report...`, delay: 6.8 }
            ]
            logSequence.forEach((log) => {
                setTimeout(() => addLog(log.text, log.color), log.delay * 1000)
            })
            setTimeout(() => {
                setDecompiledData(mockDecompilerResponse)
                setAnalysisReport(mockAnalysisResponse)
                setAnalyzing(false)
            }, 7500)
            return
        }

        // --- Real file upload to backend ---
        addLog(`[+] Initializing static analysis engine...`)
        addLog(`[+] Uploading ${file.name} to backend...`)

        const decompileFormData = new FormData()
        decompileFormData.append('file', file.rawFile)

        const analyzerFormData = new FormData()
        analyzerFormData.append('file', file.rawFile)

        try {
            addLog(`[*] Calling decompilation & threat analysis services (parallel)...`)

            const [decompileRes, analyzerRes] = await Promise.all([
                fetch('http://localhost:5000/api/malware-analyzer/decompile', {
                    method: 'POST',
                    body: decompileFormData
                }),
                fetch('http://localhost:5000/api/malware-analyzer/file-analysis', {
                    method: 'POST',
                    body: analyzerFormData
                })
            ])

            if (!decompileRes.ok) {
                throw new Error(`Decompile API error: ${decompileRes.statusText}`)
            }
            if (!analyzerRes.ok) {
                throw new Error(`Analyzer API error: ${analyzerRes.statusText}`)
            }

            const [decompileJson, analyzerJson] = await Promise.all([
                decompileRes.json(),
                analyzerRes.json()
            ])

            addLog(`[+] Decompilation complete.`, 'text-neon-green')
            addLog(`[+] Threat analysis complete.`, 'text-neon-green')

            setDecompiledData(decompileJson)
            setAnalysisReport(analyzerJson)

        } catch (err) {
            addLog(`[!] Error: ${err.message}`, 'text-red-500')
            setError(err.message)
        } finally {
            setAnalyzing(false)
        }
    }

    return (
        <div className="max-w-7xl mx-auto space-y-8 pb-20">

            {/* Header */}
            <div className="flex items-center justify-between">
                <div>
                    <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                        <Bug className="text-neon-green" /> Malware Sandbox
                    </h2>
                    <p className="text-foreground/60">Static & Dynamic Analysis Environment</p>
                </div>
                <div className="flex gap-2">
                    <div className="px-3 py-1 rounded bg-red-500/10 border border-red-500/20 text-red-500 text-xs font-mono flex items-center gap-2">
                        <ShieldAlert size={14} /> LIVE DETONATION PREPARED
                    </div>
                </div>
            </div>

            {/* Dynamic Layout Container */}
            <div className={analyzing || decompiledData ? "grid grid-cols-1 lg:grid-cols-12 gap-6" : "max-w-xl mx-auto mt-20"}>

                {/* Left Column: Upload & Control */}
                <div className={analyzing || decompiledData ? "lg:col-span-4 space-y-6" : "space-y-6"}>

                    {/* Hidden Input */}
                    <input
                        type="file"
                        ref={fileInputRef}
                        className="hidden"
                        onChange={handleFileSelect}
                    />

                    {/* Upload Zone */}
                    <motion.div
                        layout
                        className={`
               border-2 border-dashed rounded-xl p-8 flex flex-col items-center justify-center text-center transition-all cursor-pointer relative overflow-hidden
               ${file ? 'border-neon-green/50 bg-neon-green/5' : 'border-white/10 hover:border-white/20 hover:bg-white/[0.02]'}
               ${analyzing ? 'pointer-events-none opacity-50' : ''}
             `}
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={handleFileDrop}
                        onClick={() => !file && fileInputRef.current?.click()}
                    >
                        {file ? (
                            <>
                                <FileCode className="w-12 h-12 text-neon-green mb-4" />
                                <div className="font-mono text-white mb-1">{file.name}</div>
                                <div className="text-xs text-foreground/40">{file.size}</div>
                                <Button variant="outline" className="mt-4 text-xs h-8" onClick={(e) => { e.stopPropagation(); setFile(null); setDecompiledData(null); setError(null); }}>
                                    Remove
                                </Button>
                            </>
                        ) : (
                            <>
                                <Upload className="w-12 h-12 text-foreground/20 mb-4" />
                                <div className="text-foreground/60 mb-2">Drop file to detonate</div>
                                <div className="text-xs text-foreground/30 font-mono mb-4">OR CLICK TO UPLOAD</div>

                                {/* <div className="flex gap-3 mt-2">
                                    <Button variant="outline" className="text-xs h-8 px-4" onClick={loadExample}>
                                        Load Example
                                    </Button>
                                </div> */}

                                <div className="mt-6 text-[10px] text-foreground/40 font-mono border border-foreground/10 px-2 py-1 rounded">
                                    SUPPORTED: {allowedExtensions.map(e => e.toUpperCase()).join(', ')}
                                </div>
                                {error && (
                                    <motion.div
                                        initial={{ opacity: 0, y: 5 }}
                                        animate={{ opacity: 1, y: 0 }}
                                        className="mt-4 text-xs text-red-500 bg-red-500/10 px-3 py-2 rounded border border-red-500/20 flex items-center gap-2"
                                    >
                                        <ShieldAlert size={12} /> {error}
                                    </motion.div>
                                )}
                            </>
                        )}
                    </motion.div>

                    <Button
                        variant="primary"
                        className="w-full h-12 text-lg"
                        disabled={!file || analyzing}
                        onClick={handleScan}
                    >
                        {analyzing ? (
                            <span className="flex items-center gap-2">
                                <Activity className="animate-spin" /> Analyzing...
                            </span>
                        ) : 'Submit File'}
                    </Button>

                    {/* Sandbox Log Terminal - Show when analyzing or results exist */}
                    {(analyzing || decompiledData) && (
                        <motion.div
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            className="rounded-xl border border-white/10 bg-black p-4 font-mono h-[300px] overflow-y-auto custom-scrollbar relative"
                        >
                            <div className="absolute top-2 right-4 text-xs text-foreground/20 flex items-center gap-1">
                                <Terminal size={12} /> STATIC ANALYSIS LOG
                            </div>
                            <div className="space-y-1 mt-4">
                                {logs.map((log, i) => (
                                    <TerminalLine key={i} text={log.text} color={log.color} />
                                ))}
                                {analyzing && (
                                    <motion.div
                                        animate={{ opacity: [0, 1, 0] }}
                                        transition={{ duration: 0.8, repeat: Infinity }}
                                        className="w-2 h-4 bg-neon-green mt-1 inline-block"
                                    />
                                )}
                            </div>
                        </motion.div>
                    )}

                    {/* Analysis Stats (Left Column Results) */}
                    {analysisReport && (
                        <motion.div
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            className="space-y-4"
                        >
                            <div className="p-4 rounded-xl border border-white/10 bg-white/[0.03]">
                                <h4 className="text-sm font-bold text-white mb-3 flex items-center gap-2">
                                    <ShieldAlert size={14} className="text-red-500" />
                                    Threat Intelligence
                                </h4>
                                <div className="flex justify-between items-center mb-4">
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-red-500">{analysisReport.report.data.attributes.stats.malicious}</div>
                                        <div className="text-[10px] text-foreground/40 uppercase">Malicious</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-neon-yellow">{analysisReport.report.data.attributes.stats.suspicious}</div>
                                        <div className="text-[10px] text-foreground/40 uppercase">Suspicious</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-green-500">{analysisReport.report.data.attributes.stats.harmless}</div>
                                        <div className="text-[10px] text-foreground/40 uppercase">Harmless</div>
                                    </div>
                                </div>
                                <div className="text-xs font-mono text-foreground/60 space-y-1 border-t border-white/5 pt-3">
                                    <div className="flex justify-between"><span>SHA256:</span> <span className="text-white">{analysisReport.report.meta.file_info.sha256.substring(0, 12)}...</span></div>
                                    <div className="flex justify-between"><span>Size:</span> <span className="text-white">{analysisReport.report.meta.file_info.size} bytes</span></div>
                                    <div className="flex justify-between"><span>Format:</span> <span className="text-white">ELF 64-bit</span></div>
                                </div>
                            </div>
                        </motion.div>
                    )}
                </div>

                {/* Right Column: Code Editor Results - Only show when analyzing or results exist */}
                {/* Right Column: Code Editor Results - Only show when analyzing or results exist */}
                {(analyzing || decompiledData) && (
                    <div className="lg:col-span-8 flex flex-col min-h-[600px]">
                        {!decompiledData ? (
                            // Placeholder while analyzing
                            <div className="h-full rounded-xl border border-white/5 bg-white/[0.02] flex flex-col items-center justify-center text-foreground/20 animate-pulse min-h-[600px]">
                                <Code className="w-24 h-24 mb-4 opacity-20" />
                                <p>Decompiling binary...</p>
                                <p className="text-xs mt-2">Running objdump & Ghidra analysis</p>
                            </div>
                        ) : (
                            <motion.div
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                className="flex flex-col bg-[#1e1e1e] rounded-xl border border-white/10 overflow-hidden shadow-2xl"
                            >
                                {/* Editor Header */}
                                <div className="flex items-center justify-between px-4 py-2 bg-[#2d2d2d] border-b border-black">
                                    <div className="flex items-center gap-1">
                                        <button
                                            onClick={() => setActiveTab('decompiled')}
                                            className={`px-3 py-1.5 text-xs font-mono flex items-center gap-2 rounded-t transition-colors ${activeTab === 'decompiled' ? 'bg-[#1e1e1e] text-neon-green' : 'text-foreground/40 hover:text-foreground'}`}
                                        >
                                            <Code size={12} /> pseudo_code.c
                                        </button>
                                        <button
                                            onClick={() => setActiveTab('objdump')}
                                            className={`px-3 py-1.5 text-xs font-mono flex items-center gap-2 rounded-t transition-colors ${activeTab === 'objdump' ? 'bg-[#1e1e1e] text-neon-yellow' : 'text-foreground/40 hover:text-foreground'}`}
                                        >
                                            <Binary size={12} /> disassembly.asm
                                        </button>
                                    </div>
                                    <div className="text-[10px] text-foreground/30 font-mono">
                                        READ-ONLY
                                    </div>
                                </div>

                                {/* Editor Content */}
                                <div className={`relative p-4 font-mono text-sm bg-[#1e1e1e] ${isExpanded ? '' : 'max-h-[600px] overflow-hidden'}`}>
                                    <pre className="text-gray-300 leading-relaxed overflow-x-auto">
                                        <code>
                                            {activeTab === 'decompiled' ? decompiledData.decompiled : decompiledData.objdump}
                                        </code>
                                    </pre>

                                    {/* Gradient Overlay for collapsed state */}
                                    {!isExpanded && (
                                        <div className="absolute inset-x-0 bottom-0 h-40 bg-gradient-to-t from-[#1e1e1e] via-[#1e1e1e]/80 to-transparent pointer-events-none" />
                                    )}
                                </div>

                                {/* Toggle Button */}
                                <div className="bg-[#1e1e1e] border-t border-white/5 p-2 flex justify-center sticky bottom-0 z-10">
                                    <button
                                        onClick={() => setIsExpanded(!isExpanded)}
                                        className="flex items-center gap-2 px-4 py-2 text-xs font-mono text-neon-green hover:bg-neon-green/10 rounded transition-colors"
                                    >
                                        {isExpanded ? (
                                            <>
                                                <ChevronUp size={14} /> Show Less
                                            </>
                                        ) : (
                                            <>
                                                <ChevronDown size={14} /> Show Full Source
                                            </>
                                        )}
                                    </button>
                                </div>
                            </motion.div>
                        )}
                    </div>
                )}
            </div>
        </div>
    )
}
