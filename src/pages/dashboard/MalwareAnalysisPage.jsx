import { useState, useRef, useEffect } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { Upload, FileCode, CheckCircle, ShieldAlert, Bug, Terminal, Activity, FileSearch, Globe, FileText, Binary, Code, ChevronDown, ChevronUp, Download, Sparkles, GitBranch, X, Loader2 } from 'lucide-react'
import { Button } from '../../components/ui/Button'
import { mockDecompilerResponse, mockAnalysisResponse } from '../../data/mockMalwareData'
import mermaid from 'mermaid'
import jsPDF from 'jspdf'
import 'jspdf-autotable'

// Initialize mermaid
mermaid.initialize({
    startOnLoad: false,
    theme: 'dark',
    securityLevel: 'loose',
    themeVariables: {
        primaryColor: '#39FF14',
        primaryTextColor: '#fff',
        primaryBorderColor: '#39FF14',
        lineColor: '#666',
        secondaryColor: '#1a1a2e',
        tertiaryColor: '#0a0e17',
        background: '#0a0e17',
        mainBkg: '#1a1a2e',
        nodeBorder: '#39FF14',
        clusterBkg: '#1a1a2e',
        clusterBorder: '#333',
        titleColor: '#39FF14',
        edgeLabelBackground: '#1a1a2e',
    }
})

const TerminalLine = ({ text, delay = 0, color = 'text-foreground/70' }) => (
    <motion.div
        initial={{ opacity: 0, x: -10 }}
        animate={{ opacity: 1, x: 0 }}
        transition={{ delay, duration: 0.3 }}
        className={`font-mono text-xs ${color}`}
    >
        <span className="text-foreground/30 mr-2">$</span>
        {text}
    </motion.div>
)

export default function MalwareAnalysisPage() {
    const [file, setFile] = useState(null)
    const [analyzing, setAnalyzing] = useState(false)
    const [decompiledData, setDecompiledData] = useState(null)
    const [analysisReport, setAnalysisReport] = useState(null)
    const [logs, setLogs] = useState([])
    const [error, setError] = useState(null)
    const [activeTab, setActiveTab] = useState('decompiled')
    const [isExpanded, setIsExpanded] = useState(false)
    const fileInputRef = useRef(null)

    // New states for AI features
    const [aiSummary, setAiSummary] = useState(null)
    const [aiSummaryLoading, setAiSummaryLoading] = useState(false)
    const [diagram, setDiagram] = useState(null)
    const [diagramLoading, setDiagramLoading] = useState(false)
    const [showDiagramModal, setShowDiagramModal] = useState(false)
    const [showSummaryModal, setShowSummaryModal] = useState(false)
    const [pdfGenerating, setPdfGenerating] = useState(false)

    const diagramRef = useRef(null)

    const allowedExtensions = ['exe', 'dll', 'so', 'elf', 'bin', 'o', 'out']

    const validateFile = (fileName) => {
        const extension = fileName.split('.').pop().toLowerCase()
        if (!allowedExtensions.includes(extension)) {
            setError(`Invalid file type. Allowed: ${allowedExtensions.join(', ').toUpperCase()}`)
            return false
        }
        setError(null)
        return true
    }

    const handleFileSelect = (e) => {
        if (e.target.files && e.target.files[0]) {
            const selectedFile = e.target.files[0]
            if (validateFile(selectedFile.name)) {
                setFile({
                    name: selectedFile.name,
                    size: (selectedFile.size / (1024 * 1024)).toFixed(2) + ' MB',
                    rawFile: selectedFile,
                    isExample: false
                })
            }
        }
    }

    const handleFileDrop = (e) => {
        e.preventDefault()
        const droppedFile = e.dataTransfer.files[0]
        if (droppedFile) {
            if (validateFile(droppedFile.name)) {
                setFile({
                    name: droppedFile.name,
                    size: (droppedFile.size / (1024 * 1024)).toFixed(2) + ' MB',
                    rawFile: droppedFile,
                    isExample: false
                })
            }
        }
    }

    const loadExample = (e) => {
        e.stopPropagation()
        setError(null)
        setFile({ name: 'malware.out', size: '12.6 KB', isExample: true })
    }

    const addLog = (text, color = 'text-foreground/70') => {
        setLogs(prev => [...prev, { text, color }])
    }

    // Generate AI Summary
    const generateAiSummary = async () => {
        if (!file?.rawFile) return
        setAiSummaryLoading(true)
        setAiSummary(null)

        try {
            const formData = new FormData()
            formData.append('file', file.rawFile)

            const res = await fetch('http://localhost:5000/api/malware-analyzer/ai-summary', {
                method: 'POST',
                body: formData
            })

            if (!res.ok) throw new Error(`API error: ${res.statusText}`)
            const data = await res.json()

            if (data.success) {
                setAiSummary(data.ai_response)
                setShowSummaryModal(true)
            } else {
                throw new Error(data.error || 'Failed to generate summary')
            }
        } catch (err) {
            setError(err.message)
        } finally {
            setAiSummaryLoading(false)
        }
    }

    // Generate Diagram
    const generateDiagram = async () => {
        if (!file?.rawFile) return
        setDiagramLoading(true)
        setDiagram(null)

        try {
            const formData = new FormData()
            formData.append('file', file.rawFile)

            const res = await fetch('http://localhost:5000/api/malware-analyzer/diagram-generator', {
                method: 'POST',
                body: formData
            })

            if (!res.ok) throw new Error(`API error: ${res.statusText}`)
            const data = await res.json()

            if (data.success) {
                setDiagram(data.ai_response)
                setShowDiagramModal(true)
            } else {
                throw new Error(data.error || 'Failed to generate diagram')
            }
        } catch (err) {
            setError(err.message)
        } finally {
            setDiagramLoading(false)
        }
    }

    // Render mermaid diagram when it changes
    useEffect(() => {
        if (diagram && showDiagramModal && diagramRef.current) {
            const renderDiagram = async () => {
                try {
                    diagramRef.current.innerHTML = ''
                    const { svg } = await mermaid.render('mermaid-diagram', diagram)
                    diagramRef.current.innerHTML = svg
                } catch (err) {
                    console.error('Mermaid render error:', err)
                    diagramRef.current.innerHTML = `<pre class="text-red-500 text-sm">${err.message}</pre>`
                }
            }
            renderDiagram()
        }
    }, [diagram, showDiagramModal])

    // Generate PDF Report
    const generatePdfReport = async () => {
        if (!analysisReport || !decompiledData) return
        setPdfGenerating(true)

        try {
            const pdf = new jsPDF('p', 'mm', 'a4')
            const pageWidth = pdf.internal.pageSize.getWidth()
            const pageHeight = pdf.internal.pageSize.getHeight()

            // Colors
            const neonGreen = [57, 255, 20]
            const darkBg = [10, 14, 23]
            const white = [255, 255, 255]
            const red = [239, 68, 68]
            const yellow = [250, 204, 21]
            const green = [34, 197, 94]

            // Header Background
            pdf.setFillColor(...darkBg)
            pdf.rect(0, 0, pageWidth, 45, 'F')

            // Header gradient line
            pdf.setDrawColor(...neonGreen)
            pdf.setLineWidth(1)
            pdf.line(0, 45, pageWidth, 45)

            // Logo/Brand
            pdf.setTextColor(...neonGreen)
            pdf.setFontSize(24)
            pdf.setFont('helvetica', 'bold')
            pdf.text('IntelX', 15, 20)

            pdf.setTextColor(...white)
            pdf.setFontSize(10)
            pdf.setFont('helvetica', 'normal')
            pdf.text('MALWARE ANALYSIS REPORT', 15, 28)

            // Report metadata
            pdf.setFontSize(8)
            pdf.setTextColor(180, 180, 180)
            pdf.text(`Generated: ${new Date().toLocaleString()}`, 15, 38)
            pdf.text(`File: ${file?.name || 'Unknown'}`, pageWidth - 60, 38)

            // Threat Level Banner
            const stats = analysisReport.report.data.attributes.stats
            const threatLevel = stats.malicious > 5 ? 'HIGH' : stats.malicious > 0 ? 'MEDIUM' : 'LOW'
            const threatColor = threatLevel === 'HIGH' ? red : threatLevel === 'MEDIUM' ? yellow : green

            pdf.setFillColor(...threatColor)
            pdf.roundedRect(pageWidth - 55, 12, 40, 12, 2, 2, 'F')
            pdf.setTextColor(0, 0, 0)
            pdf.setFontSize(8)
            pdf.setFont('helvetica', 'bold')
            pdf.text(`THREAT: ${threatLevel}`, pageWidth - 52, 20)

            // File Information Section
            let yPos = 55

            pdf.setTextColor(...neonGreen)
            pdf.setFontSize(12)
            pdf.setFont('helvetica', 'bold')
            pdf.text('FILE INFORMATION', 15, yPos)
            yPos += 8

            pdf.setTextColor(...white)
            pdf.setFontSize(9)
            pdf.setFont('helvetica', 'normal')

            const fileInfo = analysisReport.report.meta.file_info
            const fileData = [
                ['Filename', file?.name || 'N/A'],
                ['SHA256', fileInfo.sha256],
                ['MD5', fileInfo.md5],
                ['File Size', `${fileInfo.size} bytes`],
                ['File Type', 'ELF 64-bit executable'],
            ]

            pdf.autoTable({
                startY: yPos,
                head: [],
                body: fileData,
                theme: 'plain',
                styles: {
                    textColor: [255, 255, 255],
                    fontSize: 8,
                    cellPadding: 2,
                },
                columnStyles: {
                    0: { fontStyle: 'bold', textColor: [150, 150, 150], cellWidth: 35 },
                    1: { fontStyle: 'normal', textColor: [255, 255, 255] },
                },
                margin: { left: 15 },
            })

            yPos = pdf.lastAutoTable.finalY + 10

            // Threat Intelligence Section
            pdf.setTextColor(...neonGreen)
            pdf.setFontSize(12)
            pdf.setFont('helvetica', 'bold')
            pdf.text('THREAT INTELLIGENCE', 15, yPos)
            yPos += 8

            // Stats boxes
            const boxWidth = 50
            const boxHeight = 25
            const boxSpacing = 5
            const startX = 15

            // Malicious box
            pdf.setFillColor(239, 68, 68, 0.2)
            pdf.setDrawColor(239, 68, 68)
            pdf.roundedRect(startX, yPos, boxWidth, boxHeight, 2, 2, 'FD')
            pdf.setTextColor(...red)
            pdf.setFontSize(16)
            pdf.setFont('helvetica', 'bold')
            pdf.text(String(stats.malicious), startX + boxWidth / 2, yPos + 12, { align: 'center' })
            pdf.setFontSize(7)
            pdf.text('MALICIOUS', startX + boxWidth / 2, yPos + 20, { align: 'center' })

            // Suspicious box
            pdf.setFillColor(250, 204, 21, 0.2)
            pdf.setDrawColor(250, 204, 21)
            pdf.roundedRect(startX + boxWidth + boxSpacing, yPos, boxWidth, boxHeight, 2, 2, 'FD')
            pdf.setTextColor(...yellow)
            pdf.setFontSize(16)
            pdf.setFont('helvetica', 'bold')
            pdf.text(String(stats.suspicious), startX + boxWidth + boxSpacing + boxWidth / 2, yPos + 12, { align: 'center' })
            pdf.setFontSize(7)
            pdf.text('SUSPICIOUS', startX + boxWidth + boxSpacing + boxWidth / 2, yPos + 20, { align: 'center' })

            // Harmless box
            pdf.setFillColor(34, 197, 94, 0.2)
            pdf.setDrawColor(34, 197, 94)
            pdf.roundedRect(startX + 2 * (boxWidth + boxSpacing), yPos, boxWidth, boxHeight, 2, 2, 'FD')
            pdf.setTextColor(...green)
            pdf.setFontSize(16)
            pdf.setFont('helvetica', 'bold')
            pdf.text(String(stats.harmless), startX + 2 * (boxWidth + boxSpacing) + boxWidth / 2, yPos + 12, { align: 'center' })
            pdf.setFontSize(7)
            pdf.text('HARMLESS', startX + 2 * (boxWidth + boxSpacing) + boxWidth / 2, yPos + 20, { align: 'center' })

            yPos += boxHeight + 15

            // Decompiled Code Preview Section
            pdf.setTextColor(...neonGreen)
            pdf.setFontSize(12)
            pdf.setFont('helvetica', 'bold')
            pdf.text('DECOMPILED CODE (PREVIEW)', 15, yPos)
            yPos += 5

            // Code box background
            pdf.setFillColor(30, 30, 30)
            pdf.setDrawColor(60, 60, 60)
            const codeBoxHeight = 60
            pdf.roundedRect(15, yPos, pageWidth - 30, codeBoxHeight, 2, 2, 'FD')

            // Code text
            pdf.setTextColor(200, 200, 200)
            pdf.setFontSize(6)
            pdf.setFont('courier', 'normal')

            const codeLines = decompiledData.decompiled.split('\n').slice(0, 20)
            let codeY = yPos + 5
            codeLines.forEach((line, i) => {
                if (codeY < yPos + codeBoxHeight - 5) {
                    const truncatedLine = line.substring(0, 100)
                    pdf.text(truncatedLine, 18, codeY)
                    codeY += 3
                }
            })

            yPos += codeBoxHeight + 10

            // AI Summary Section (if available)
            if (aiSummary) {
                if (yPos > pageHeight - 60) {
                    pdf.addPage()
                    yPos = 20
                }

                pdf.setTextColor(...neonGreen)
                pdf.setFontSize(12)
                pdf.setFont('helvetica', 'bold')
                pdf.text('AI ANALYSIS SUMMARY', 15, yPos)
                yPos += 8

                pdf.setTextColor(...white)
                pdf.setFontSize(8)
                pdf.setFont('helvetica', 'normal')

                const summaryLines = pdf.splitTextToSize(aiSummary, pageWidth - 30)
                pdf.text(summaryLines.slice(0, 15), 15, yPos)
            }

            // Footer
            const addFooter = (pageNum) => {
                pdf.setFillColor(...darkBg)
                pdf.rect(0, pageHeight - 15, pageWidth, 15, 'F')
                pdf.setDrawColor(...neonGreen)
                pdf.line(0, pageHeight - 15, pageWidth, pageHeight - 15)

                pdf.setTextColor(...neonGreen)
                pdf.setFontSize(8)
                pdf.text('IntelX Security Platform', 15, pageHeight - 6)
                pdf.setTextColor(150, 150, 150)
                pdf.text(`Page ${pageNum}`, pageWidth - 25, pageHeight - 6)
                pdf.text('CONFIDENTIAL', pageWidth / 2, pageHeight - 6, { align: 'center' })
            }

            // Add footers to all pages
            const totalPages = pdf.internal.getNumberOfPages()
            for (let i = 1; i <= totalPages; i++) {
                pdf.setPage(i)
                addFooter(i)
            }

            // Save PDF
            pdf.save(`IntelX_MalwareReport_${file?.name || 'analysis'}_${Date.now()}.pdf`)

        } catch (err) {
            console.error('PDF generation error:', err)
            setError('Failed to generate PDF report')
        } finally {
            setPdfGenerating(false)
        }
    }

    const handleScan = async () => {
        if (!file) return
        setAnalyzing(true)
        setLogs([])
        setDecompiledData(null)
        setAnalysisReport(null)
        setAiSummary(null)
        setDiagram(null)
        setError(null)

        // If it's the example file, use mock data
        if (file.isExample) {
            const logSequence = [
                { text: `[+] Initializing static analysis engine...`, delay: 0.2 },
                { text: `[+] Uploading ${file.name} to sandbox...`, delay: 0.8 },
                { text: `[*] Parsing ELF header structure...`, delay: 1.5 },
                { text: `[*] Disassembling .text section...`, delay: 2.2 },
                { text: `[*] Reconstructing control flow graph...`, delay: 3.0 },
                { text: `[*] Extracting symbol table...`, delay: 3.8 },
                { text: `[*] Analyzing entropy and sections...`, delay: 4.5 },
                { text: `[+] Querying threat intelligence database...`, delay: 5.2 },
                { text: `[!] Suspicious system calls detected...`, delay: 6.0, color: 'text-neon-yellow' },
                { text: `[+] Generating decompilation report...`, delay: 6.8 }
            ]
            logSequence.forEach((log) => {
                setTimeout(() => addLog(log.text, log.color), log.delay * 1000)
            })
            setTimeout(() => {
                setDecompiledData(mockDecompilerResponse)
                setAnalysisReport(mockAnalysisResponse)
                setAnalyzing(false)
            }, 7500)
            return
        }

        // --- Real file upload to backend ---
        addLog(`[+] Initializing static analysis engine...`)
        addLog(`[+] Uploading ${file.name} to backend...`)

        const decompileFormData = new FormData()
        decompileFormData.append('file', file.rawFile)

        const analyzerFormData = new FormData()
        analyzerFormData.append('file', file.rawFile)

        try {
            addLog(`[*] Calling decompilation & threat analysis services (parallel)...`)

            const [decompileRes, analyzerRes] = await Promise.all([
                fetch('http://localhost:5000/api/malware-analyzer/decompile', {
                    method: 'POST',
                    body: decompileFormData
                }),
                fetch('http://localhost:5000/api/malware-analyzer/file-analysis', {
                    method: 'POST',
                    body: analyzerFormData
                })
            ])

            if (!decompileRes.ok) {
                throw new Error(`Decompile API error: ${decompileRes.statusText}`)
            }
            if (!analyzerRes.ok) {
                throw new Error(`Analyzer API error: ${analyzerRes.statusText}`)
            }

            const [decompileJson, analyzerJson] = await Promise.all([
                decompileRes.json(),
                analyzerRes.json()
            ])

            addLog(`[+] Decompilation complete.`, 'text-neon-green')
            addLog(`[+] Threat analysis complete.`, 'text-neon-green')

            setDecompiledData(decompileJson)
            setAnalysisReport(analyzerJson)

        } catch (err) {
            addLog(`[!] Error: ${err.message}`, 'text-red-500')
            setError(err.message)
        } finally {
            setAnalyzing(false)
        }
    }

    return (
        <div className="max-w-7xl mx-auto space-y-8 pb-20">

            {/* Header */}
            <div className="flex items-center justify-between">
                <div>
                    <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                        <Bug className="text-neon-green" /> Malware Sandbox
                    </h2>
                    <p className="text-foreground/60">Static & Dynamic Analysis Environment</p>
                </div>
                <div className="flex gap-2 items-center">
                    {/* Download PDF Button */}
                    {analysisReport && (
                        <Button
                            variant="outline"
                            className="text-xs h-9 px-4 flex items-center gap-2"
                            onClick={generatePdfReport}
                            disabled={pdfGenerating}
                        >
                            {pdfGenerating ? (
                                <Loader2 size={14} className="animate-spin" />
                            ) : (
                                <Download size={14} />
                            )}
                            {pdfGenerating ? 'Generating...' : 'Download Report'}
                        </Button>
                    )}
                    <div className="px-3 py-1 rounded bg-red-500/10 border border-red-500/20 text-red-500 text-xs font-mono flex items-center gap-2">
                        <ShieldAlert size={14} /> LIVE DECOMPILATION PREPARED
                    </div>
                </div>
            </div>

            {/* Dynamic Layout Container */}
            <div className={analyzing || decompiledData ? "grid grid-cols-1 lg:grid-cols-12 gap-6" : "max-w-xl mx-auto mt-20"}>

                {/* Left Column: Upload & Control */}
                <div className={analyzing || decompiledData ? "lg:col-span-4 space-y-6" : "space-y-6"}>

                    {/* Hidden Input */}
                    <input
                        type="file"
                        ref={fileInputRef}
                        className="hidden"
                        onChange={handleFileSelect}
                    />

                    {/* Upload Zone */}
                    <motion.div
                        layout
                        className={`
               border-2 border-dashed rounded-xl p-8 flex flex-col items-center justify-center text-center transition-all cursor-pointer relative overflow-hidden
               ${file ? 'border-neon-green/50 bg-neon-green/5' : 'border-white/10 hover:border-white/20 hover:bg-white/[0.02]'}
               ${analyzing ? 'pointer-events-none opacity-50' : ''}
             `}
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={handleFileDrop}
                        onClick={() => !file && fileInputRef.current?.click()}
                    >
                        {file ? (
                            <>
                                <FileCode className="w-12 h-12 text-neon-green mb-4" />
                                <div className="font-mono text-white mb-1">{file.name}</div>
                                <div className="text-xs text-foreground/40">{file.size}</div>
                                <Button variant="outline" className="mt-4 text-xs h-8" onClick={(e) => { e.stopPropagation(); setFile(null); setDecompiledData(null); setAnalysisReport(null); setAiSummary(null); setDiagram(null); setError(null); }}>
                                    Remove
                                </Button>
                            </>
                        ) : (
                            <>
                                <Upload className="w-12 h-12 text-foreground/20 mb-4" />
                                <div className="text-foreground/60 mb-2">Drop file to analyze</div>
                                <div className="text-xs text-foreground/30 font-mono mb-4">OR CLICK TO UPLOAD</div>

                                <div className="mt-6 text-[10px] text-foreground/40 font-mono border border-foreground/10 px-2 py-1 rounded">
                                    SUPPORTED: {allowedExtensions.map(e => e.toUpperCase()).join(', ')}
                                </div>
                                {error && (
                                    <motion.div
                                        initial={{ opacity: 0, y: 5 }}
                                        animate={{ opacity: 1, y: 0 }}
                                        className="mt-4 text-xs text-red-500 bg-red-500/10 px-3 py-2 rounded border border-red-500/20 flex items-center gap-2"
                                    >
                                        <ShieldAlert size={12} /> {error}
                                    </motion.div>
                                )}
                            </>
                        )}
                    </motion.div>

                    <Button
                        variant="primary"
                        className="w-full h-12 text-lg"
                        disabled={!file || analyzing}
                        onClick={handleScan}
                    >
                        {analyzing ? (
                            <span className="flex items-center gap-2">
                                <Activity className="animate-spin" /> Analyzing...
                            </span>
                        ) : 'Submit File'}
                    </Button>

                    {/* Sandbox Log Terminal - Show when analyzing or results exist */}
                    {(analyzing || decompiledData) && (
                        <motion.div
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            className="rounded-xl border border-white/10 bg-black p-4 font-mono h-[300px] overflow-y-auto custom-scrollbar relative"
                        >
                            <div className="absolute top-2 right-4 text-xs text-foreground/20 flex items-center gap-1">
                                <Terminal size={12} /> STATIC ANALYSIS LOG
                            </div>
                            <div className="space-y-1 mt-4">
                                {logs.map((log, i) => (
                                    <TerminalLine key={i} text={log.text} color={log.color} />
                                ))}
                                {analyzing && (
                                    <motion.div
                                        animate={{ opacity: [0, 1, 0] }}
                                        transition={{ duration: 0.8, repeat: Infinity }}
                                        className="w-2 h-4 bg-neon-green mt-1 inline-block"
                                    />
                                )}
                            </div>
                        </motion.div>
                    )}

                    {/* Analysis Stats (Left Column Results) */}
                    {analysisReport && (
                        <motion.div
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            className="space-y-4"
                        >
                            <div className="p-4 rounded-xl border border-white/10 bg-white/[0.03]">
                                <h4 className="text-sm font-bold text-white mb-3 flex items-center gap-2">
                                    <ShieldAlert size={14} className="text-red-500" />
                                    Threat Intelligence
                                </h4>
                                <div className="flex justify-between items-center mb-4">
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-red-500">{analysisReport.report.data.attributes.stats.malicious}</div>
                                        <div className="text-[10px] text-foreground/40 uppercase">Malicious</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-neon-yellow">{analysisReport.report.data.attributes.stats.suspicious}</div>
                                        <div className="text-[10px] text-foreground/40 uppercase">Suspicious</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-green-500">{analysisReport.report.data.attributes.stats.harmless}</div>
                                        <div className="text-[10px] text-foreground/40 uppercase">Harmless</div>
                                    </div>
                                </div>
                                <div className="text-xs font-mono text-foreground/60 space-y-1 border-t border-white/5 pt-3">
                                    <div className="flex justify-between"><span>SHA256:</span> <span className="text-white">{analysisReport.report.meta.file_info.sha256.substring(0, 12)}...</span></div>
                                    <div className="flex justify-between"><span>Size:</span> <span className="text-white">{analysisReport.report.meta.file_info.size} bytes</span></div>
                                    <div className="flex justify-between"><span>Format:</span> <span className="text-white">ELF 64-bit</span></div>
                                </div>
                            </div>

                            {/* AI Features Box */}
                            <div className="p-4 rounded-xl border border-white/10 bg-[#1e1e1e]">
                                <h4 className="text-sm font-bold text-white mb-3 flex items-center gap-2">
                                    <Sparkles size={14} className="text-neon-green" />
                                    AI-Powered Insights
                                </h4>
                                <div className="space-y-2">
                                    {/* AI Summary Button */}
                                    <button
                                        onClick={generateAiSummary}
                                        disabled={aiSummaryLoading || !file?.rawFile}
                                        className="w-full p-3 rounded-lg border border-white/10 bg-black/50 hover:bg-white/5 hover:border-neon-green/30 transition-all flex items-center justify-between group disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center">
                                                <Sparkles size={16} className="text-purple-400" />
                                            </div>
                                            <div className="text-left">
                                                <div className="text-sm font-medium text-white">AI Summary</div>
                                                <div className="text-xs text-foreground/40">Generate threat analysis</div>
                                            </div>
                                        </div>
                                        {aiSummaryLoading ? (
                                            <Loader2 size={16} className="animate-spin text-purple-400" />
                                        ) : (
                                            <ChevronDown size={16} className="text-foreground/40 group-hover:text-neon-green transition-colors" />
                                        )}
                                    </button>

                                    {/* Diagram Button */}
                                    <button
                                        onClick={generateDiagram}
                                        disabled={diagramLoading || !file?.rawFile}
                                        className="w-full p-3 rounded-lg border border-white/10 bg-black/50 hover:bg-white/5 hover:border-neon-green/30 transition-all flex items-center justify-between group disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-lg bg-cyan-500/20 flex items-center justify-center">
                                                <GitBranch size={16} className="text-cyan-400" />
                                            </div>
                                            <div className="text-left">
                                                <div className="text-sm font-medium text-white">Flow Diagram</div>
                                                <div className="text-xs text-foreground/40">Visualize execution flow</div>
                                            </div>
                                        </div>
                                        {diagramLoading ? (
                                            <Loader2 size={16} className="animate-spin text-cyan-400" />
                                        ) : (
                                            <ChevronDown size={16} className="text-foreground/40 group-hover:text-neon-green transition-colors" />
                                        )}
                                    </button>
                                </div>
                            </div>
                        </motion.div>
                    )}
                </div>

                {/* Right Column: Code Editor Results */}
                {(analyzing || decompiledData) && (
                    <div className="lg:col-span-8 flex flex-col min-h-[600px]">
                        {!decompiledData ? (
                            <div className="h-full rounded-xl border border-white/5 bg-white/[0.02] flex flex-col items-center justify-center text-foreground/20 animate-pulse min-h-[600px]">
                                <Code className="w-24 h-24 mb-4 opacity-20" />
                                <p>Decompiling binary...</p>
                                <p className="text-xs mt-2">Running objdump & Ghidra analysis</p>
                            </div>
                        ) : (
                            <motion.div
                                initial={{ opacity: 0 }}
                                animate={{ opacity: 1 }}
                                className="flex flex-col bg-[#1e1e1e] rounded-xl border border-white/10 overflow-hidden shadow-2xl"
                            >
                                {/* Editor Header */}
                                <div className="flex items-center justify-between px-4 py-2 bg-[#2d2d2d] border-b border-black">
                                    <div className="flex items-center gap-1">
                                        <button
                                            onClick={() => setActiveTab('decompiled')}
                                            className={`px-3 py-1.5 text-xs font-mono flex items-center gap-2 rounded-t transition-colors ${activeTab === 'decompiled' ? 'bg-[#1e1e1e] text-neon-green' : 'text-foreground/40 hover:text-foreground'}`}
                                        >
                                            <Code size={12} /> pseudo_code.c
                                        </button>
                                        <button
                                            onClick={() => setActiveTab('objdump')}
                                            className={`px-3 py-1.5 text-xs font-mono flex items-center gap-2 rounded-t transition-colors ${activeTab === 'objdump' ? 'bg-[#1e1e1e] text-neon-yellow' : 'text-foreground/40 hover:text-foreground'}`}
                                        >
                                            <Binary size={12} /> disassembly.asm
                                        </button>
                                    </div>
                                    <div className="text-[10px] text-foreground/30 font-mono">
                                        READ-ONLY
                                    </div>
                                </div>

                                {/* Editor Content */}
                                <div className={`relative p-4 font-mono text-sm bg-[#1e1e1e] ${isExpanded ? '' : 'max-h-[600px] overflow-hidden'}`}>
                                    <pre className="text-gray-300 leading-relaxed overflow-x-auto">
                                        <code>
                                            {activeTab === 'decompiled' ? decompiledData.decompiled : decompiledData.objdump}
                                        </code>
                                    </pre>

                                    {!isExpanded && (
                                        <div className="absolute inset-x-0 bottom-0 h-40 bg-gradient-to-t from-[#1e1e1e] via-[#1e1e1e]/80 to-transparent pointer-events-none" />
                                    )}
                                </div>

                                {/* Toggle Button */}
                                <div className="bg-[#1e1e1e] border-t border-white/5 p-2 flex justify-center sticky bottom-0 z-10">
                                    <button
                                        onClick={() => setIsExpanded(!isExpanded)}
                                        className="flex items-center gap-2 px-4 py-2 text-xs font-mono text-neon-green hover:bg-neon-green/10 rounded transition-colors"
                                    >
                                        {isExpanded ? (
                                            <>
                                                <ChevronUp size={14} /> Show Less
                                            </>
                                        ) : (
                                            <>
                                                <ChevronDown size={14} /> Show Full Source
                                            </>
                                        )}
                                    </button>
                                </div>
                            </motion.div>
                        )}
                    </div>
                )}
            </div>

            {/* AI Summary Modal */}
            <AnimatePresence>
                {showSummaryModal && (
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
                        onClick={() => setShowSummaryModal(false)}
                    >
                        <motion.div
                            initial={{ scale: 0.9, opacity: 0 }}
                            animate={{ scale: 1, opacity: 1 }}
                            exit={{ scale: 0.9, opacity: 0 }}
                            className="bg-[#0a0e17] border border-white/10 rounded-xl max-w-3xl w-full max-h-[80vh] overflow-hidden shadow-2xl"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <div className="flex items-center justify-between p-4 border-b border-white/10">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                                        <Sparkles size={20} className="text-purple-400" />
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-bold text-white">AI Analysis Summary</h3>
                                        <p className="text-xs text-foreground/40">{file?.name}</p>
                                    </div>
                                </div>
                                <button
                                    onClick={() => setShowSummaryModal(false)}
                                    className="p-2 hover:bg-white/10 rounded-lg transition-colors"
                                >
                                    <X size={20} className="text-foreground/60" />
                                </button>
                            </div>
                            <div className="p-6 overflow-y-auto max-h-[60vh] custom-scrollbar">
                                <div className="prose prose-invert prose-sm max-w-none">
                                    <pre className="whitespace-pre-wrap text-sm text-foreground/80 font-mono bg-black/50 p-4 rounded-lg border border-white/5">
                                        {aiSummary}
                                    </pre>
                                </div>
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>

            {/* Diagram Modal */}
            <AnimatePresence>
                {showDiagramModal && (
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
                        onClick={() => setShowDiagramModal(false)}
                    >
                        <motion.div
                            initial={{ scale: 0.9, opacity: 0 }}
                            animate={{ scale: 1, opacity: 1 }}
                            exit={{ scale: 0.9, opacity: 0 }}
                            className="bg-[#0a0e17] border border-white/10 rounded-xl max-w-5xl w-full max-h-[90vh] overflow-hidden shadow-2xl"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <div className="flex items-center justify-between p-4 border-b border-white/10">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-lg bg-cyan-500/20 flex items-center justify-center">
                                        <GitBranch size={20} className="text-cyan-400" />
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-bold text-white">Execution Flow Diagram</h3>
                                        <p className="text-xs text-foreground/40">{file?.name}</p>
                                    </div>
                                </div>
                                <button
                                    onClick={() => setShowDiagramModal(false)}
                                    className="p-2 hover:bg-white/10 rounded-lg transition-colors"
                                >
                                    <X size={20} className="text-foreground/60" />
                                </button>
                            </div>
                            <div className="p-6 overflow-auto max-h-[75vh] custom-scrollbar flex items-center justify-center bg-[#1a1a2e]">
                                <div ref={diagramRef} className="mermaid-container w-full min-h-[400px] flex items-center justify-center" />
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>
        </div>
    )
}
